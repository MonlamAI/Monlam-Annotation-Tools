<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Change Password - Monlam Annotation</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@5.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'MonlamTBslim';
            src: url('/static/fonts/monlam_uni_slim.ttf') format('truetype');
        }
        body {
            font-family: MonlamTBslim, 'Noto Sans Tibetan', Roboto, sans-serif !important;
        }
        .v-application {
            font-family: MonlamTBslim, 'Noto Sans Tibetan', Roboto, sans-serif !important;
        }
    </style>
</head>
<body>
    <div id="app">
        <v-app>
            <v-app-bar app color="primary" dark>
                <v-btn icon @click="goBack">
                    <v-icon>mdi-arrow-left</v-icon>
                </v-btn>
                <v-toolbar-title>གསང་ཨང་བསྒྱུར་བ། (Change Password)</v-toolbar-title>
                <v-spacer></v-spacer>
                <span v-if="username">[[ username ]]</span>
            </v-app-bar>

            <v-main>
                <v-container class="fill-height" fluid>
                    <v-row align="center" justify="center">
                        <v-col cols="12" sm="8" md="4">
                            <v-card class="elevation-12">
                                <v-toolbar color="primary" dark flat>
                                    <v-toolbar-title>གསང་ཨང་གསར་པ་བཟོ་བ།</v-toolbar-title>
                                </v-toolbar>
                                <v-card-text>
                                    <v-alert v-if="error" type="error" dismissible>
                                        [[ error ]]
                                    </v-alert>
                                    <v-alert v-if="success" type="success" dismissible>
                                        [[ success ]]
                                    </v-alert>
                                    
                                    <v-form ref="form" v-model="valid" @submit.prevent="changePassword">
                                        <v-text-field
                                            v-model="oldPassword"
                                            :append-icon="showOld ? 'mdi-eye' : 'mdi-eye-off'"
                                            :type="showOld ? 'text' : 'password'"
                                            :rules="[rules.required]"
                                            label="གསང་ཨང་རྙིང་པ། (Current Password)"
                                            prepend-icon="mdi-lock"
                                            @click:append="showOld = !showOld"
                                        ></v-text-field>
                                        
                                        <v-text-field
                                            v-model="newPassword1"
                                            :append-icon="showNew ? 'mdi-eye' : 'mdi-eye-off'"
                                            :type="showNew ? 'text' : 'password'"
                                            :rules="[rules.required, rules.min]"
                                            label="གསང་ཨང་གསར་པ། (New Password)"
                                            prepend-icon="mdi-lock-outline"
                                            hint="At least 8 characters"
                                            @click:append="showNew = !showNew"
                                        ></v-text-field>
                                        
                                        <v-text-field
                                            v-model="newPassword2"
                                            :append-icon="showConfirm ? 'mdi-eye' : 'mdi-eye-off'"
                                            :type="showConfirm ? 'text' : 'password'"
                                            :rules="[rules.required, rules.match]"
                                            label="གསང་ཨང་གསར་པ་བསྐྱར་ཞུགས། (Confirm New Password)"
                                            prepend-icon="mdi-lock-check"
                                            @click:append="showConfirm = !showConfirm"
                                        ></v-text-field>
                                    </v-form>
                                </v-card-text>
                                <v-card-actions>
                                    <v-spacer></v-spacer>
                                    <v-btn text @click="goBack">Cancel</v-btn>
                                    <v-btn 
                                        color="primary" 
                                        :loading="loading"
                                        :disabled="!valid"
                                        @click="changePassword"
                                    >
                                        གསང་ཨང་བསྒྱུར། (Change Password)
                                    </v-btn>
                                </v-card-actions>
                            </v-card>
                        </v-col>
                    </v-row>
                </v-container>
            </v-main>
        </v-app>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script>
        new Vue({
            el: '#app',
            vuetify: new Vuetify({
                theme: { dark: false }
            }),
            delimiters: ['[[', ']]'],
            data: {
                username: '',
                oldPassword: '',
                newPassword1: '',
                newPassword2: '',
                showOld: false,
                showNew: false,
                showConfirm: false,
                valid: false,
                loading: false,
                error: null,
                success: null,
                rules: {
                    required: v => !!v || 'Required field',
                    min: v => (v && v.length >= 8) || 'Min 8 characters',
                    match: v => v === this.newPassword1 || 'Passwords must match'
                }
            },
            created() {
                this.fetchUser();
            },
            methods: {
                async fetchUser() {
                    try {
                        const response = await fetch('/v1/me');
                        if (response.ok) {
                            const data = await response.json();
                            this.username = data.username;
                        }
                    } catch (e) {
                        console.error('Failed to fetch user:', e);
                    }
                },
                getCsrfToken() {
                    const cookies = document.cookie.split(';');
                    for (let cookie of cookies) {
                        const [name, value] = cookie.trim().split('=');
                        if (name === 'csrftoken') {
                            return value;
                        }
                    }
                    return '';
                },
                async changePassword() {
                    if (!this.$refs.form.validate()) return;
                    
                    this.loading = true;
                    this.error = null;
                    this.success = null;
                    
                    try {
                        const response = await fetch('/monlam/api/change-password/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCsrfToken()
                            },
                            body: JSON.stringify({
                                old_password: this.oldPassword,
                                new_password1: this.newPassword1,
                                new_password2: this.newPassword2
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok && data.success) {
                            this.success = 'Password changed successfully! གསང་ཨང་བསྒྱུར་ཐུབ་སོང་།';
                            this.oldPassword = '';
                            this.newPassword1 = '';
                            this.newPassword2 = '';
                            this.$refs.form.resetValidation();
                            
                            // Redirect after 2 seconds
                            setTimeout(() => {
                                window.location.href = '/projects/';
                            }, 2000);
                        } else {
                            // Handle error response
                            if (data.old_password) {
                                const oldPasswordErrors = Array.isArray(data.old_password) ? data.old_password : [data.old_password];
                                this.error = 'Current password is incorrect. གསང་ཨང་རྙིང་པ་ནོར་འདུག: ' + oldPasswordErrors.join(', ');
                            } else if (data.new_password2) {
                                const newPasswordErrors = Array.isArray(data.new_password2) ? data.new_password2 : [data.new_password2];
                                this.error = 'Password validation error: ' + newPasswordErrors.join(', ');
                            } else if (data.error) {
                                this.error = data.error;
                            } else {
                                this.error = 'Failed to change password. ' + (data.detail || JSON.stringify(data));
                            }
                        }
                    } catch (e) {
                        this.error = 'Network error. Please try again.';
                    } finally {
                        this.loading = false;
                    }
                },
                goBack() {
                    window.history.back();
                }
            }
        });
    </script>
</body>
</html>

