<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Completion Dashboard - {{ project.name }}</title>
    
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@5.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
        .page-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .page-header h1 { margin: 0; font-size: 28px; font-weight: 500; }
        .page-header p { margin: 8px 0 0 0; opacity: 0.9; font-size: 14px; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="page-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>üìà Completion Dashboard</h1>
                <p>Project: {{ project.name }} (ID: {{ project_id }})</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <a href="/projects/{{ project_id }}/dataset/" style="color: white; text-decoration: none; background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 20px; display: inline-flex; align-items: center; gap: 8px;">
                    <span style="font-size: 20px;">üìä</span>
                    <span>Dataset</span>
                </a>
                <a href="/projects/{{ project_id }}/" style="color: white; text-decoration: none; background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 20px; display: inline-flex; align-items: center; gap: 8px;">
                    <span style="font-size: 20px;">üè†</span>
                    <span>Back to Project</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Vue App -->
    <div id="app">
        <v-app>
            <v-container fluid class="pa-4">
                <!-- Summary Cards -->
                <v-row v-if="!loading && !error">
                    <v-col cols="12" sm="6" md="2">
                        <v-card color="blue lighten-5" elevation="2">
                            <v-card-text>
                                <div class="text-h4 text-center">[[ stats.summary.total_examples || 0 ]]</div>
                                <div class="text-center text--secondary">Total Examples</div>
                            </v-card-text>
                        </v-card>
                    </v-col>
                    
                    <v-col cols="12" sm="6" md="2">
                        <v-card color="purple lighten-5" elevation="2">
                            <v-card-text>
                                <div class="text-h4 text-center">[[ stats.summary.confirmed || 0 ]]</div>
                                <div class="text-center text--secondary">Confirmed ‚úì</div>
                                <div class="text-center text-caption">
                                    [[ calculatePercentage(stats.summary.confirmed, stats.summary.total_examples) ]]%
                                </div>
                            </v-card-text>
                        </v-card>
                    </v-col>
                    
                    <v-col cols="12" sm="6" md="2">
                        <v-card color="grey lighten-4" elevation="2">
                            <v-card-text>
                                <div class="text-h4 text-center">[[ stats.summary.pending || 0 ]]</div>
                                <div class="text-center text--secondary">Pending</div>
                            </v-card-text>
                        </v-card>
                    </v-col>
                    
                    <v-col cols="12" sm="6" md="2">
                        <v-card color="orange lighten-5" elevation="2">
                            <v-card-text>
                                <div class="text-h4 text-center">[[ stats.summary.submitted || 0 ]]</div>
                                <div class="text-center text--secondary">Awaiting Review</div>
                            </v-card-text>
                        </v-card>
                    </v-col>
                    
                    <v-col cols="12" sm="6" md="2">
                        <v-card color="green lighten-5" elevation="2">
                            <v-card-text>
                                <div class="text-h4 text-center">[[ stats.summary.approved || 0 ]]</div>
                                <div class="text-center text--secondary">Approved</div>
                            </v-card-text>
                        </v-card>
                    </v-col>
                    
                    <v-col cols="12" sm="6" md="2">
                        <v-card color="purple lighten-5" elevation="2">
                            <v-card-text>
                                <div class="text-h4 text-center">[[ stats.summary.final_approved || 0 ]]</div>
                                <div class="text-center text--secondary">üëë Final Approved</div>
                                <div class="text-center text-caption">
                                    [[ calculatePercentage(stats.summary.final_approved, stats.summary.total_examples) ]]%
                                </div>
                            </v-card-text>
                        </v-card>
                    </v-col>
                    
                    <v-col cols="12" sm="6" md="2">
                        <v-card color="red lighten-5" elevation="2">
                            <v-card-text>
                                <div class="text-h4 text-center">[[ stats.summary.rejected || 0 ]]</div>
                                <div class="text-center text--secondary">Rejected</div>
                            </v-card-text>
                        </v-card>
                    </v-col>
                </v-row>
                
                <!-- Loading State -->
                <v-row v-if="loading">
                    <v-col cols="12" class="text-center">
                        <v-progress-circular indeterminate color="primary" size="64"></v-progress-circular>
                        <p class="mt-4">Loading completion data...</p>
                    </v-col>
                </v-row>
                
                <!-- Error State -->
                <v-alert v-if="error" type="error" prominent class="mt-4">
                    <v-row align="center">
                        <v-col class="grow">[[ error ]]</v-col>
                        <v-col class="shrink">
                            <v-btn @click="loadData">Retry</v-btn>
                        </v-col>
                    </v-row>
                </v-alert>
                
                <!-- Annotators Table -->
                <v-row v-if="!loading && !error" class="mt-4">
                    <v-col cols="12">
                        <v-card elevation="2">
                            <v-card-title class="blue darken-1 white--text">
                                <v-icon left dark>mdi-account-edit</v-icon>
                                Annotator Progress
                            </v-card-title>
                            <v-data-table
                                :headers="annotatorHeaders"
                                :items="stats.annotators"
                                :items-per-page="10"
                                class="elevation-1"
                            >
                                <template v-slot:item.annotated_by__username="{ item }">
                                    <v-chip small color="primary" dark>
                                        <v-icon small left>mdi-account</v-icon>
                                        [[ item.annotated_by__username ]]
                                    </v-chip>
                                </template>
                                
                                <template v-slot:item.progress="{ item }">
                                    <v-progress-linear
                                        :value="calculatePercentage(item.approved, item.total_annotated)"
                                        height="20"
                                        color="success"
                                    >
                                        [[ calculatePercentage(item.approved, item.total_annotated) ]]%
                                    </v-progress-linear>
                                </template>
                                
                                <template v-slot:item.submitted="{ item }">
                                    <v-chip small :color="item.submitted > 0 ? 'orange' : 'grey'" dark>
                                        [[ item.submitted ]]
                                    </v-chip>
                                </template>
                                
                                <template v-slot:item.approved="{ item }">
                                    <v-chip small :color="item.approved > 0 ? 'green' : 'grey'" dark>
                                        [[ item.approved ]]
                                    </v-chip>
                                </template>
                                
                                <template v-slot:item.rejected="{ item }">
                                    <v-chip small :color="item.rejected > 0 ? 'red' : 'grey'" dark>
                                        [[ item.rejected ]]
                                    </v-chip>
                                </template>
                            </v-data-table>
                        </v-card>
                    </v-col>
                </v-row>
                
                <!-- Approvers Table -->
                <v-row v-if="!loading && !error && stats.approvers && stats.approvers.length > 0" class="mt-4">
                    <v-col cols="12">
                        <v-card elevation="2">
                            <v-card-title class="secondary white--text">
                                <v-icon left dark>mdi-check-circle</v-icon>
                                Approver Activity
                            </v-card-title>
                            <v-data-table
                                :headers="approverHeaders"
                                :items="stats.approvers"
                                :items-per-page="10"
                                class="elevation-1"
                            >
                                <template v-slot:item.reviewed_by__username="{ item }">
                                    <v-chip small color="secondary" dark>
                                        <v-icon small left>mdi-shield-check</v-icon>
                                        [[ item.reviewed_by__username ]]
                                    </v-chip>
                                </template>
                                
                                <template v-slot:item.role="{ item }">
                                    <v-chip 
                                        small 
                                        :color="item.role === 'project_admin' ? 'purple' : 'orange'" 
                                        dark
                                    >
                                        <v-icon small left>[[ item.role === 'project_admin' ? 'mdi-crown' : 'mdi-check-circle' ]]</v-icon>
                                        [[ item.role === 'project_admin' ? 'üëë Final Approver' : '‚úì Approver' ]]
                                    </v-chip>
                                </template>
                                
                                <template v-slot:item.approved="{ item }">
                                    <v-chip small color="green" dark>
                                        ‚úì [[ item.approved ]]
                                    </v-chip>
                                </template>
                                
                                <template v-slot:item.final_approved="{ item }">
                                    <v-chip 
                                        small 
                                        :color="item.final_approved > 0 ? 'purple' : 'grey'" 
                                        dark
                                    >
                                        <v-icon small left>mdi-crown</v-icon>
                                        [[ item.final_approved || 0 ]]
                                    </v-chip>
                                </template>
                                
                                <template v-slot:item.rejected="{ item }">
                                    <v-chip small color="red" dark>
                                        ‚úó [[ item.rejected ]]
                                    </v-chip>
                                </template>
                            </v-data-table>
                        </v-card>
                    </v-col>
                </v-row>
                
                <!-- Quick Actions -->
                <v-row v-if="!loading && !error" class="mt-4">
                    <v-col cols="12">
                        <v-card elevation="2">
                            <v-card-title>Quick Actions</v-card-title>
                            <v-card-actions>
                                <v-btn color="primary" :href="'/projects/{{ project_id }}/dataset/'">
                                    <v-icon left>mdi-table</v-icon>
                                    Dataset
                                </v-btn>
                                <v-btn color="secondary" :href="'/projects/{{ project_id }}/'">
                                    <v-icon left>mdi-folder</v-icon>
                                    Project Home
                                </v-btn>
                                <v-spacer></v-spacer>
                                <v-btn color="info" @click="loadData">
                                    <v-icon left>mdi-refresh</v-icon>
                                    Refresh
                                </v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-col>
                </v-row>
            </v-container>
        </v-app>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
    new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        vuetify: new Vuetify({
            theme: {
                themes: {
                    light: {
                        primary: '#1976d2',
                        secondary: '#424242',
                    },
                },
            },
        }),
        data: {
            loading: true,
            error: null,
            stats: {
                summary: {},
                annotators: [],
                approvers: [],
            },
            annotatorHeaders: [
                { text: 'Annotator', value: 'annotated_by__username', sortable: true },
                { text: 'Total Annotated', value: 'total_annotated', sortable: true },
                { text: 'Submitted', value: 'submitted', sortable: true },
                { text: 'Approved', value: 'approved', sortable: true },
                { text: 'Rejected', value: 'rejected', sortable: true },
                { text: 'Approval Rate', value: 'progress', sortable: false },
            ],
            approverHeaders: [
                { text: 'Approver', value: 'reviewed_by__username', sortable: true },
                { text: 'Role', value: 'role', sortable: true },
                { text: 'Total Reviewed', value: 'total_reviewed', sortable: true },
                { text: 'Approved', value: 'approved', sortable: true },
                { text: 'Final Approved', value: 'final_approved', sortable: true },
                { text: 'Rejected', value: 'rejected', sortable: true },
            ],
        },
        mounted() {
            console.log('‚úÖ Completion Dashboard mounted!');
            this.loadData();
        },
        methods: {
            async loadData() {
                this.loading = true;
                this.error = null;
                console.log('üì• Loading completion stats...');
                
                try {
                    const response = await axios.get('/monlam/{{ project_id }}/api/completion-stats/');
                    this.stats = response.data;
                    console.log('‚úÖ Loaded stats:', this.stats);
                    console.log('üìä Approvers data:', this.stats.approvers);
                    console.log('üìä Approvers count:', this.stats.approvers ? this.stats.approvers.length : 'undefined');
                } catch (err) {
                    console.error('‚ùå Failed to load:', err);
                    this.error = 'Failed to load completion data: ' + (err.response?.data?.detail || err.message);
                } finally {
                    this.loading = false;
                }
            },
            calculatePercentage(value, total) {
                if (!total || total === 0) return 0;
                return Math.round((value / total) * 100);
            },
        },
    });
    </script>
</body>
</html>
