{% extends "monlam_ui/base.html" %}

{% block title %}Dataset - {{ project.name }} - Monlam Tools{% endblock %}

{% block content %}
<div id="dataset-app">
    <v-row>
        <v-col cols="12">
            <v-card>
                <v-card-title>
                    <v-icon left color="primary">mdi-table</v-icon>
                    Dataset: {{ project.name }}
                    <v-spacer></v-spacer>
                    <v-text-field
                        v-model="search"
                        append-icon="mdi-magnify"
                        label="Search"
                        single-line
                        hide-details
                        class="mr-4"
                        style="max-width: 300px;"
                    ></v-text-field>
                    <v-btn color="primary" @click="loadData">
                        <v-icon left>mdi-refresh</v-icon>
                        Refresh
                    </v-btn>
                </v-card-title>
            </v-card>
        </v-col>
    </v-row>
    
    <!-- Loading State -->
    <v-row v-if="loading">
        <v-col cols="12" class="text-center">
            <v-progress-circular indeterminate color="primary" size="64"></v-progress-circular>
            <p class="mt-4">Loading dataset...</p>
        </v-col>
    </v-row>
    
    <!-- Error State -->
    <v-row v-if="error">
        <v-col cols="12">
            <v-alert type="error" prominent>
                <v-row align="center">
                    <v-col class="grow">[[ error ]]</v-col>
                    <v-col class="shrink">
                        <v-btn @click="loadData">Retry</v-btn>
                    </v-col>
                </v-row>
            </v-alert>
        </v-col>
    </v-row>
    
    <!-- Status Summary for Approvers/PMs -->
    <v-row v-if="!loading && !error">
        <v-col cols="12">
            <v-card color="blue lighten-5">
                <v-card-title>
                    <v-icon left color="blue darken-2">mdi-chart-donut</v-icon>
                    Quick Status Summary
                </v-card-title>
                <v-card-text>
                    <v-row>
                        <v-col cols="6" md="2">
                            <v-chip class="ma-1" color="grey" text-color="white" large>
                                <v-icon left>mdi-clock-outline</v-icon>
                                Assigned: [[ statusCounts.assigned ]]
                            </v-chip>
                        </v-col>
                        <v-col cols="6" md="2">
                            <v-chip class="ma-1" color="blue" text-color="white" large>
                                <v-icon left>mdi-progress-clock</v-icon>
                                In Progress: [[ statusCounts.in_progress ]]
                            </v-chip>
                        </v-col>
                        <v-col cols="6" md="2">
                            <v-chip class="ma-1" color="orange" text-color="white" large @click="filterStatus = 'submitted'">
                                <v-icon left>mdi-file-upload</v-icon>
                                ‚ö†Ô∏è Needs Review: [[ statusCounts.submitted ]]
                            </v-chip>
                        </v-col>
                        <v-col cols="6" md="2">
                            <v-chip class="ma-1" color="purple" text-color="white" large @click="filterStatus = 'approved'; filterRole = 'approver'">
                                <v-icon left>mdi-alert-circle</v-icon>
                                üëë PM Review: [[ statusCounts.approved_by_approver ]]
                            </v-chip>
                        </v-col>
                        <v-col cols="6" md="2">
                            <v-chip class="ma-1" color="green darken-1" text-color="white" large>
                                <v-icon left>mdi-check-all</v-icon>
                                ‚úÖ Final: [[ statusCounts.approved_by_pm ]]
                            </v-chip>
                        </v-col>
                        <v-col cols="6" md="2">
                            <v-chip class="ma-1" color="red" text-color="white" large @click="filterStatus = 'rejected'">
                                <v-icon left>mdi-close-circle</v-icon>
                                Rejected: [[ statusCounts.rejected ]]
                            </v-chip>
                        </v-col>
                        <v-col cols="6" md="2">
                            <v-chip class="ma-1" color="grey lighten-1" text-color="white" large>
                                <v-icon left>mdi-help-circle</v-icon>
                                Unassigned: [[ statusCounts.unassigned ]]
                            </v-chip>
                        </v-col>
                    </v-row>
                    <v-divider class="my-3"></v-divider>
                    <v-row>
                        <v-col cols="12">
                            <v-alert v-if="statusCounts.submitted > 0" type="warning" dense border="left">
                                <strong>Action Required (Approvers):</strong> [[ statusCounts.submitted ]] example(s) submitted and awaiting approver review!
                                <v-btn small color="orange" dark class="ml-3" @click="filterStatus = 'submitted'; filterRole = null">
                                    Review Now ‚Üí
                                </v-btn>
                            </v-alert>
                            <v-alert v-if="statusCounts.approved_by_approver > 0" type="info" dense border="left">
                                <strong>Action Required (Project Manager):</strong> [[ statusCounts.approved_by_approver ]] example(s) approved by approver and awaiting PM final review!
                                <v-btn small color="purple" dark class="ml-3" @click="filterStatus = 'approved'; filterRole = 'approver'">
                                    Review Now ‚Üí
                                </v-btn>
                            </v-alert>
                            <v-alert v-if="statusCounts.rejected > 0" type="error" dense border="left">
                                <strong>Attention:</strong> [[ statusCounts.rejected ]] example(s) rejected and need to be fixed.
                            </v-alert>
                            <v-alert v-if="statusCounts.submitted === 0 && statusCounts.approved_by_approver === 0 && statusCounts.rejected === 0" type="success" dense border="left">
                                ‚úÖ No pending reviews! All caught up.
                            </v-alert>
                        </v-col>
                    </v-row>
                </v-card-text>
            </v-card>
        </v-col>
    </v-row>
    
    <!-- Dataset Table -->
    <v-row v-if="!loading && !error">
        <v-col cols="12">
            <v-card>
                <!-- Status Filter Tabs -->
                <v-tabs v-model="filterTab" background-color="primary" dark>
                    <v-tab @click="filterStatus = null; filterRole = null">
                        <v-icon left>mdi-view-list</v-icon>
                        All ([[ examples.length ]])
                    </v-tab>
                    <v-tab @click="filterStatus = 'submitted'; filterRole = null">
                        <v-icon left>mdi-file-upload</v-icon>
                        Needs Approver Review ([[ statusCounts.submitted ]])
                        <v-badge v-if="statusCounts.submitted > 0" color="orange" :content="statusCounts.submitted" inline></v-badge>
                    </v-tab>
                    <v-tab @click="filterStatus = 'approved'; filterRole = 'approver'">
                        <v-icon left>mdi-alert-circle</v-icon>
                        üëë Needs PM Final Review ([[ statusCounts.approved_by_approver ]])
                        <v-badge v-if="statusCounts.approved_by_approver > 0" color="purple" :content="statusCounts.approved_by_approver" inline></v-badge>
                    </v-tab>
                    <v-tab @click="filterStatus = 'approved'; filterRole = 'project_manager'">
                        <v-icon left>mdi-check-all</v-icon>
                        Final Approved ([[ statusCounts.approved_by_pm ]])
                    </v-tab>
                    <v-tab @click="filterStatus = 'in_progress'; filterRole = null">
                        <v-icon left>mdi-progress-clock</v-icon>
                        In Progress ([[ statusCounts.in_progress ]])
                    </v-tab>
                    <v-tab @click="filterStatus = 'rejected'; filterRole = null">
                        <v-icon left>mdi-close-circle</v-icon>
                        Rejected ([[ statusCounts.rejected ]])
                    </v-tab>
                </v-tabs>
                
                <v-data-table
                    :headers="headers"
                    :items="filteredExamples"
                    :search="search"
                    :items-per-page="25"
                    :footer-props="{
                        'items-per-page-options': [10, 25, 50, 100]
                    }"
                    class="elevation-1"
                >
                    <!-- Example ID Column -->
                    <template v-slot:item.id="{ item }">
                        <v-chip small color="grey lighten-2">
                            [[ item.id ]]
                        </v-chip>
                    </template>
                    
                    <!-- Text/Audio Column -->
                    <template v-slot:item.text="{ item }">
                        <div v-if="item.filename && item.filename.includes('.wav')">
                            <audio :src="item.filename" controls style="max-width: 300px; height: 30px;"></audio>
                        </div>
                        <div v-else-if="item.text">
                            [[ item.text.substring(0, 100) ]][[ item.text.length > 100 ? '...' : '' ]]
                        </div>
                        <span v-else class="text--secondary">No content</span>
                    </template>
                    
                    <!-- Assigned To Column -->
                    <template v-slot:item.assigned_to="{ item }">
                        <div v-if="item.assignment">
                            <v-chip small color="primary" text-color="white">
                                <v-icon small left>mdi-account</v-icon>
                                [[ item.assignment.assigned_to_username ]]
                            </v-chip>
                        </div>
                        <v-chip v-else small color="grey" text-color="white">
                            Not assigned
                        </v-chip>
                    </template>
                    
                    <!-- Status Column -->
                    <template v-slot:item.status="{ item }">
                        <v-chip
                            v-if="item.assignment"
                            small
                            :color="getStatusColor(item.assignment.status)"
                            text-color="white"
                        >
                            <v-icon small left>[[ getStatusIcon(item.assignment.status) ]]</v-icon>
                            [[ item.assignment.status.replace('_', ' ').toUpperCase() ]]
                        </v-chip>
                        <v-chip v-else small color="grey lighten-2">
                            Not started
                        </v-chip>
                    </template>
                    
                    <!-- Approver Column with Role Badge -->
                    <template v-slot:item.approver="{ item }">
                        <div v-if="item.assignment && item.assignment.reviewed_by_username">
                            <v-chip 
                                small 
                                :color="getReviewerChipColor(item.assignment)"
                                text-color="white"
                            >
                                <v-icon small left>mdi-check-circle</v-icon>
                                [[ item.assignment.reviewed_by_username ]]
                            </v-chip>
                            <v-chip 
                                x-small 
                                :color="getReviewerRoleBadgeColor(item.assignment)"
                                text-color="white"
                                class="ml-1"
                            >
                                [[ getReviewerRoleLabel(item.assignment) ]]
                            </v-chip>
                            <div class="text-caption mt-1">
                                [[ formatDate(item.assignment.reviewed_at) ]]
                            </div>
                        </div>
                        <v-chip v-else small color="grey lighten-2">
                            <v-icon small left>mdi-clock-outline</v-icon>
                            Awaiting review
                        </v-chip>
                    </template>
                    
                    <!-- Actions Column -->
                    <template v-slot:item.actions="{ item }">
                        <v-tooltip bottom v-if="item.assignment && item.assignment.status === 'submitted'">
                            <template v-slot:activator="{ on, attrs }">
                                <v-btn
                                    small
                                    color="orange"
                                    dark
                                    :href="`/monlam/{{ project_id }}/annotate/${item.id}/`"
                                    v-bind="attrs"
                                    v-on="on"
                                >
                                    <v-icon small left>mdi-eye-check</v-icon>
                                    Review
                                </v-btn>
                            </template>
                            <span>Review this submitted annotation</span>
                        </v-tooltip>
                        <v-btn
                            v-else
                            small
                            color="primary"
                            :href="`/monlam/{{ project_id }}/annotate/${item.id}/`"
                        >
                            <v-icon small left>mdi-pencil</v-icon>
                            Annotate
                        </v-btn>
                    </template>
                </v-data-table>
            </v-card>
        </v-col>
    </v-row>
    
    <!-- Quick Actions -->
    <v-row v-if="!loading && !error">
        <v-col cols="12">
            <v-card>
                <v-card-actions>
                    <v-btn color="primary" @click="goToCompletion">
                        <v-icon left>mdi-chart-box</v-icon>
                        Completion Dashboard
                    </v-btn>
                    <v-btn color="secondary" @click="goToProject">
                        <v-icon left>mdi-folder</v-icon>
                        Back to Project
                    </v-btn>
                </v-card-actions>
            </v-card>
        </v-col>
    </v-row>
</div>
{% endblock %}

{% block extra_js %}
<script>
new Vue({
    el: '#dataset-app',
    delimiters: ['[[', ']]'],
    vuetify: new Vuetify({
        theme: {
            themes: {
                light: {
                    primary: '#B8963E',
                    secondary: '#1a1a2e',
                },
            },
        },
    }),
    data: {
        loading: true,
        error: null,
        search: '',
        examples: [],
        assignments: {},
        filterStatus: null,
        filterRole: null,  // New: filter by reviewer role
        filterTab: 0,
        headers: [
            { text: 'ID', value: 'id', sortable: true, width: '80px' },
            { text: 'Content', value: 'text', sortable: false },
            { text: 'Assigned To', value: 'assigned_to', sortable: true },
            { text: 'Status', value: 'status', sortable: true },
            { text: 'Reviewed By', value: 'approver', sortable: true },
            { text: 'Actions', value: 'actions', sortable: false, width: '120px' },
        ],
    },
    computed: {
        filteredExamples() {
            let filtered = this.examples;
            
            // Filter by status
            if (this.filterStatus) {
                filtered = filtered.filter(ex => 
                    ex.assignment && ex.assignment.status === this.filterStatus
                );
            }
            
            // Filter by reviewer role (for distinguishing approver vs PM approval)
            if (this.filterRole) {
                filtered = filtered.filter(ex => 
                    ex.assignment && 
                    ex.assignment.reviewed_by_role === this.filterRole
                );
            }
            
            return filtered;
        },
        statusCounts() {
            const counts = {
                assigned: 0,
                in_progress: 0,
                submitted: 0,
                approved: 0,
                approved_by_approver: 0,  // Approved by approver (needs PM review)
                approved_by_pm: 0,        // Final approval by PM
                rejected: 0,
                unassigned: 0
            };
            
            this.examples.forEach(ex => {
                if (!ex.assignment) {
                    counts.unassigned++;
                } else {
                    const status = ex.assignment.status;
                    
                    // Count approved separately by reviewer role
                    if (status === 'approved') {
                        if (ex.assignment.reviewed_by_role === 'project_manager') {
                            counts.approved_by_pm++;
                        } else if (ex.assignment.reviewed_by_role === 'approver') {
                            counts.approved_by_approver++;
                        }
                        counts.approved++;  // Total approved
                    } else if (counts.hasOwnProperty(status)) {
                        counts[status]++;
                    }
                }
            });
            
            return counts;
        }
    },
    mounted() {
        this.loadData();
    },
    methods: {
        async loadData() {
            this.loading = true;
            this.error = null;
            
            try {
                // Load examples
                const examplesResponse = await axios.get('/v1/projects/{{ project_id }}/examples?limit=1000');
                const examples = examplesResponse.data.results || [];
                
                // Load assignments
                const assignmentsResponse = await axios.get('/monlam/{{ project_id }}/api/dataset-assignments/');
                const assignments = assignmentsResponse.data.results || [];
                
                // Create assignment lookup by example_id
                const assignmentMap = {};
                assignments.forEach(a => {
                    assignmentMap[a.example_id] = a;
                });
                
                // Merge assignment data into examples
                this.examples = examples.map(ex => ({
                    ...ex,
                    assignment: assignmentMap[ex.id] || null
                }));
                
                console.log('Loaded', this.examples.length, 'examples with assignments');
            } catch (err) {
                console.error('Failed to load dataset:', err);
                this.error = 'Failed to load dataset. Please try again.';
            } finally {
                this.loading = false;
            }
        },
        getStatusColor(status) {
            const colors = {
                'assigned': 'grey',
                'in_progress': 'blue',
                'submitted': 'orange',
                'approved': 'green',
                'rejected': 'red'
            };
            return colors[status] || 'grey';
        },
        getStatusIcon(status) {
            const icons = {
                'assigned': 'mdi-clock-outline',
                'in_progress': 'mdi-progress-clock',
                'submitted': 'mdi-file-upload',
                'approved': 'mdi-check-circle',
                'rejected': 'mdi-close-circle'
            };
            return icons[status] || 'mdi-help-circle';
        },
        formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        },
        goToCompletion() {
            window.location.href = '/monlam/{{ project_id }}/completion/';
        },
        goToProject() {
            window.location.href = '/projects/{{ project_id }}';
        },
        getReviewerChipColor(assignment) {
            // Color based on reviewer role
            if (assignment.reviewed_by_role === 'project_manager') {
                return 'green darken-1'; // PM = darker green
            } else if (assignment.reviewed_by_role === 'approver') {
                return 'blue darken-1'; // Approver = blue
            }
            return 'secondary';
        },
        getReviewerRoleBadgeColor(assignment) {
            if (assignment.reviewed_by_role === 'project_manager') {
                return 'purple'; // PM badge = purple
            } else if (assignment.reviewed_by_role === 'approver') {
                return 'orange darken-2'; // Approver badge = orange (needs PM review)
            }
            return 'grey';
        },
        getReviewerRoleLabel(assignment) {
            if (assignment.reviewed_by_role === 'project_manager') {
                return 'üëë PM FINAL';
            } else if (assignment.reviewed_by_role === 'approver') {
                return '‚úì Approver';
            }
            return 'Reviewer';
        },
    },
});
</script>
{% endblock %}

