<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Dataset - {{ project.name }}</title>
    
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@5.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
        .page-header { background: #1976d2; color: white; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .page-header h1 { margin: 0; font-size: 28px; font-weight: 500; }
        .page-header p { margin: 8px 0 0 0; opacity: 0.9; font-size: 14px; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="page-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>üìä Enhanced Dataset View</h1>
                <p>Project: {{ project.name }} (ID: {{ project_id }})</p>
            </div>
            <div>
                <a href="/projects/{{ project_id }}/" style="color: white; text-decoration: none; background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 20px; display: inline-flex; align-items: center; gap: 8px;">
                    <span style="font-size: 20px;">üè†</span>
                    <span>Back to Project</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Vue App -->
    <div id="app">
        <v-app>
            <v-container fluid class="pa-4">
                <!-- Status Summary -->
                <v-row>
                    <v-col cols="12">
                        <v-card elevation="2">
                            <v-card-title class="blue darken-1 white--text">
                                <v-icon left dark>mdi-chart-bar</v-icon>
                                Quick Status Summary
                            </v-card-title>
                            <v-card-text class="pt-4">
                                <v-row v-if="!loading && !error">
                                    <v-col cols="6" sm="4" md="2">
                                        <v-chip class="ma-1" color="grey" dark>
                                            <v-icon small left>mdi-clock-outline</v-icon>
                                            Assigned: [[ statusCounts.assigned ]]
                                        </v-chip>
                                    </v-col>
                                    <v-col cols="6" sm="4" md="2">
                                        <v-chip class="ma-1" color="blue" dark>
                                            <v-icon small left>mdi-progress-clock</v-icon>
                                            In Progress: [[ statusCounts.in_progress ]]
                                        </v-chip>
                                    </v-col>
                                    <v-col cols="6" sm="4" md="2">
                                        <v-chip class="ma-1" color="orange" dark @click="filterByStatus('submitted')">
                                            <v-icon small left>mdi-file-upload</v-icon>
                                            ‚ö†Ô∏è Submitted: [[ statusCounts.submitted ]]
                                        </v-chip>
                                    </v-col>
                                    <v-col cols="6" sm="4" md="2">
                                        <v-chip class="ma-1" color="purple" dark>
                                            <v-icon small left>mdi-crown</v-icon>
                                            üëë PM Review: [[ statusCounts.approved_by_approver ]]
                                        </v-chip>
                                    </v-col>
                                    <v-col cols="6" sm="4" md="2">
                                        <v-chip class="ma-1" color="green darken-1" dark>
                                            <v-icon small left>mdi-check-all</v-icon>
                                            ‚úÖ Final: [[ statusCounts.approved_by_pm ]]
                                        </v-chip>
                                    </v-col>
                                    <v-col cols="6" sm="4" md="2">
                                        <v-chip class="ma-1" color="red" dark>
                                            <v-icon small left>mdi-close-circle</v-icon>
                                            Rejected: [[ statusCounts.rejected ]]
                                        </v-chip>
                                    </v-col>
                                </v-row>
                                
                                <v-alert v-if="loading" type="info" dense class="mt-3">
                                    <v-progress-circular indeterminate size="20" width="2" class="mr-2"></v-progress-circular>
                                    Loading data...
                                </v-alert>
                                
                                <v-alert v-if="error" type="error" dense class="mt-3">
                                    [[ error ]]
                                    <v-btn small @click="loadData" class="ml-2">Retry</v-btn>
                                </v-alert>
                                
                                <v-alert v-if="!loading && !error && statusCounts.submitted > 0" type="warning" dense class="mt-3">
                                    <strong>Action Required:</strong> [[ statusCounts.submitted ]] examples need review!
                                    <v-btn small color="orange" dark @click="filterByStatus('submitted')" class="ml-2">
                                        Review Now ‚Üí
                                    </v-btn>
                                </v-alert>
                            </v-card-text>
                        </v-card>
                    </v-col>
                </v-row>

                <!-- Data Table -->
                <v-row class="mt-4">
                    <v-col cols="12">
                        <v-card elevation="2">
                            <v-card-title>
                                <v-icon left color="primary">mdi-table</v-icon>
                                Dataset Table
                                <v-spacer></v-spacer>
                                <v-text-field
                                    v-model="search"
                                    append-icon="mdi-magnify"
                                    label="Search"
                                    single-line
                                    hide-details
                                    style="max-width: 300px;"
                                    class="mr-3"
                                ></v-text-field>
                                <v-btn color="primary" @click="loadData" :loading="loading">
                                    <v-icon left>mdi-refresh</v-icon>
                                    Refresh
                                </v-btn>
                            </v-card-title>
                            
                            <v-data-table
                                :headers="headers"
                                :items="filteredExamples"
                                :search="search"
                                :loading="loading"
                                :items-per-page="25"
                                :footer-props="{ 'items-per-page-options': [10, 25, 50, 100] }"
                                class="elevation-1"
                            >
                                <!-- ID Column -->
                                <template v-slot:item.id="{ item }">
                                    <v-chip small color="grey lighten-2">[[ item.id ]]</v-chip>
                                </template>
                                
                                <!-- Assigned To Column -->
                                <template v-slot:item.assigned_to="{ item }">
                                    <v-chip v-if="item.assignment" small color="primary" dark>
                                        <v-icon small left>mdi-account</v-icon>
                                        [[ item.assignment.assigned_to_username ]]
                                    </v-chip>
                                    <v-chip v-else small>Not assigned</v-chip>
                                </template>
                                
                                <!-- Status Column -->
                                <template v-slot:item.status="{ item }">
                                    <v-chip 
                                        v-if="item.assignment" 
                                        small 
                                        :color="getStatusColor(item.assignment.status)" 
                                        dark
                                    >
                                        <v-icon small left>[[ getStatusIcon(item.assignment.status) ]]</v-icon>
                                        [[ item.assignment.status.toUpperCase() ]]
                                    </v-chip>
                                    <v-chip v-else small>-</v-chip>
                                </template>
                                
                                <!-- Reviewed By Column -->
                                <template v-slot:item.reviewed_by="{ item }">
                                    <div v-if="item.assignment && item.assignment.reviewed_by_username">
                                        <v-chip small :color="getReviewerColor(item.assignment)" dark>
                                            [[ item.assignment.reviewed_by_username ]]
                                        </v-chip>
                                        <v-chip x-small :color="getRoleBadgeColor(item.assignment)" dark class="ml-1">
                                            [[ getRoleLabel(item.assignment) ]]
                                        </v-chip>
                                    </div>
                                    <v-chip v-else small>Pending</v-chip>
                                </template>
                                
                                <!-- Actions Column -->
                                <template v-slot:item.actions="{ item }">
                                    <v-btn 
                                        small 
                                        :color="item.assignment && item.assignment.status === 'submitted' ? 'orange' : 'primary'"
                                        @click="goToAnnotation(item)"
                                    >
                                        <v-icon small left>mdi-pencil</v-icon>
                                        [[ item.assignment && item.assignment.status === 'submitted' ? 'Review' : 'Annotate' ]]
                                    </v-btn>
                                </template>
                            </v-data-table>
                        </v-card>
                    </v-col>
                </v-row>
            </v-container>
        </v-app>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
    new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        vuetify: new Vuetify({
            theme: {
                themes: {
                    light: {
                        primary: '#1976d2',
                        secondary: '#424242',
                    },
                },
            },
        }),
        data: {
            loading: true,
            error: null,
            search: '',
            examples: [],
            filterStatus: null,
            headers: [
                { text: 'ID', value: 'id', sortable: true },
                { text: 'Assigned To', value: 'assigned_to', sortable: true },
                { text: 'Status', value: 'status', sortable: true },
                { text: 'Reviewed By', value: 'reviewed_by', sortable: true },
                { text: 'Actions', value: 'actions', sortable: false },
            ],
        },
        computed: {
            filteredExamples() {
                if (!this.filterStatus) return this.examples;
                return this.examples.filter(ex => 
                    ex.assignment && ex.assignment.status === this.filterStatus
                );
            },
            statusCounts() {
                const counts = {
                    assigned: 0,
                    in_progress: 0,
                    submitted: 0,
                    approved: 0,
                    approved_by_approver: 0,
                    approved_by_pm: 0,
                    rejected: 0,
                };
                
                this.examples.forEach(ex => {
                    if (ex.assignment) {
                        const status = ex.assignment.status;
                        if (status === 'approved') {
                            counts.approved++;
                            if (ex.assignment.reviewed_by_role === 'approver') {
                                counts.approved_by_approver++;
                            } else if (ex.assignment.reviewed_by_role === 'project_manager') {
                                counts.approved_by_pm++;
                            }
                        } else if (counts.hasOwnProperty(status)) {
                            counts[status]++;
                        }
                    }
                });
                
                return counts;
            }
        },
        mounted() {
            console.log('‚úÖ Vue app mounted!');
            this.loadData();
        },
        methods: {
            async loadData() {
                this.loading = true;
                this.error = null;
                console.log('üì• Loading data...');
                
                try {
                    const examplesResp = await axios.get('/v1/projects/{{ project_id }}/examples?limit=1000');
                    const examples = examplesResp.data.results || [];
                    console.log('‚úÖ Loaded', examples.length, 'examples');
                    
                    const assignmentsResp = await axios.get('/monlam/{{ project_id }}/api/dataset-assignments/');
                    const assignments = assignmentsResp.data.results || [];
                    console.log('‚úÖ Loaded', assignments.length, 'assignments');
                    
                    const assignmentMap = {};
                    assignments.forEach(a => {
                        assignmentMap[a.example_id] = a;
                    });
                    
                    this.examples = examples.map(ex => ({
                        ...ex,
                        assignment: assignmentMap[ex.id] || null
                    }));
                    
                    console.log('‚úÖ Merged data, total:', this.examples.length);
                } catch (err) {
                    console.error('‚ùå Failed to load:', err);
                    this.error = 'Failed to load data: ' + err.message;
                } finally {
                    this.loading = false;
                }
            },
            goToAnnotation(item) {
                // For approvers/PMs who need to review specific examples,
                // we need to navigate to the standard dataset page and auto-click
                // the Annotate button for this specific example
                
                console.log(`üìç Preparing to annotate example ${item.id}`);
                
                // Store the target example ID
                localStorage.setItem('monlam_auto_annotate_example_id', item.id);
                localStorage.setItem('monlam_auto_annotate_trigger', 'true');
                
                // Navigate to standard dataset page (which has working Annotate buttons)
                window.location.href = `/projects/{{ project_id }}/dataset`;
            },
            filterByStatus(status) {
                this.filterStatus = this.filterStatus === status ? null : status;
            },
            getStatusColor(status) {
                const colors = {
                    'assigned': 'grey',
                    'in_progress': 'blue',
                    'submitted': 'orange',
                    'approved': 'green',
                    'rejected': 'red'
                };
                return colors[status] || 'grey';
            },
            getStatusIcon(status) {
                const icons = {
                    'assigned': 'mdi-clock-outline',
                    'in_progress': 'mdi-progress-clock',
                    'submitted': 'mdi-file-upload',
                    'approved': 'mdi-check-circle',
                    'rejected': 'mdi-close-circle'
                };
                return icons[status] || 'mdi-help-circle';
            },
            getReviewerColor(assignment) {
                if (assignment.reviewed_by_role === 'project_manager') {
                    return 'green darken-1';
                } else if (assignment.reviewed_by_role === 'approver') {
                    return 'blue darken-1';
                }
                return 'secondary';
            },
            getRoleBadgeColor(assignment) {
                if (assignment.reviewed_by_role === 'project_manager') {
                    return 'purple';
                } else if (assignment.reviewed_by_role === 'approver') {
                    return 'orange darken-2';
                }
                return 'grey';
            },
            getRoleLabel(assignment) {
                if (assignment.reviewed_by_role === 'project_manager') {
                    return 'üëë PM FINAL';
                } else if (assignment.reviewed_by_role === 'approver') {
                    return '‚úì Approver';
                }
                return 'Reviewer';
            },
        }
    });
    </script>
</body>
</html>

