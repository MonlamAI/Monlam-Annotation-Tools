<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annotate Example {{ example_id }} - {{ project.name }}</title>
    
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@5.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background: #f5f5f5; }
        .page-header { background: linear-gradient(135deg, #43cea2 0%, #185a9d 100%); color: white; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .page-header h1 { margin: 0; font-size: 28px; font-weight: 500; }
        .page-header p { margin: 8px 0 0 0; opacity: 0.9; font-size: 14px; }
        .audio-player { width: 100%; max-width: 600px; }
        .annotation-content { background: white; padding: 20px; border-radius: 8px; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="page-header">
        <h1>üìù Annotation with Approval</h1>
        <p>Project: {{ project.name }} | Example: {{ example_id }}</p>
    </div>

    <!-- Vue App -->
    <div id="app">
        <v-app>
            <v-container fluid class="pa-4">
                <!-- Approval Status Chain -->
                <v-row v-if="assignment">
                    <v-col cols="12">
                        <v-card elevation="2" style="border-left: 4px solid #B8963E;">
                            <v-card-title class="blue-grey darken-3 white--text">
                                <v-icon left dark>mdi-timeline-check</v-icon>
                                Approval Status Chain
                            </v-card-title>
                            <v-card-text>
                                <v-row>
                                    <!-- Annotator Status -->
                                    <v-col cols="12" md="6">
                                        <div class="text-subtitle-2 mb-2">
                                            <v-icon small>mdi-account-edit</v-icon>
                                            Annotator Status
                                        </div>
                                        <v-chip
                                            :color="getStatusColor(assignment.status)"
                                            dark
                                            class="mb-2"
                                        >
                                            <v-icon small left>[[ getStatusIcon(assignment.status) ]]</v-icon>
                                            [[ assignment.status.replace('_', ' ').toUpperCase() ]]
                                        </v-chip>
                                        <div class="text-caption">
                                            Assigned to: <strong>[[ assignment.assigned_to_username || 'Unknown' ]]</strong>
                                        </div>
                                        <div v-if="assignment.submitted_at" class="text-caption text--secondary">
                                            Submitted: [[ formatDate(assignment.submitted_at) ]]
                                        </div>
                                    </v-col>
                                    
                                    <!-- Approver/PM Status -->
                                    <v-col cols="12" md="6">
                                        <div class="text-subtitle-2 mb-2">
                                            <v-icon small>mdi-check-circle</v-icon>
                                            Reviewer Status
                                        </div>
                                        <v-chip
                                            :color="getApprovalColor(assignment.status)"
                                            dark
                                            class="mb-2"
                                        >
                                            <v-icon small left>[[ getApprovalIcon(assignment.status) ]]</v-icon>
                                            [[ getApprovalText(assignment.status) ]]
                                        </v-chip>
                                        <div v-if="assignment.reviewed_by_username" class="text-caption">
                                            Reviewed by: <strong>[[ assignment.reviewed_by_username ]]</strong>
                                            <v-chip x-small :color="getRoleBadgeColor(assignment)" dark class="ml-1">
                                                [[ getRoleLabel(assignment) ]]
                                            </v-chip>
                                        </div>
                                        <div v-else class="text-caption text--secondary">
                                            Pending review
                                        </div>
                                        <div v-if="assignment.reviewed_at" class="text-caption text--secondary">
                                            Reviewed: [[ formatDate(assignment.reviewed_at) ]]
                                        </div>
                                        <div v-if="assignment.review_notes" class="text-caption mt-2">
                                            <v-icon x-small>mdi-note-text</v-icon>
                                            Notes: <em>[[ assignment.review_notes ]]</em>
                                        </div>
                                    </v-col>
                                </v-row>
                            </v-card-text>
                        </v-card>
                    </v-col>
                </v-row>
                
                <!-- Multi-Level Approval Status -->
                <v-row v-if="allApprovals && allApprovals.length > 0">
                    <v-col cols="12">
                        <v-card elevation="2" style="border-left: 4px solid #4CAF50;">
                            <v-card-title class="green darken-2 white--text">
                                <v-icon left dark>mdi-account-check</v-icon>
                                Approval Status Chain
                            </v-card-title>
                            <v-card-text>
                                <div v-for="(approval, index) in allApprovals" :key="index" class="mb-3">
                                    <v-chip
                                        :color="getApprovalStatusColor(approval.status)"
                                        dark
                                        class="mb-1"
                                    >
                                        <v-icon small left>[[ getApprovalStatusIcon(approval.status) ]]</v-icon>
                                        [[ approval.approver_role === 'project_admin' ? 'üëë Admin' : (approval.approver_role === 'annotation_approver' ? '‚úì Approver' : 'Reviewer') ]] - [[ approval.status.toUpperCase() ]]
                                    </v-chip>
                                    <div class="text-caption">
                                        <strong>[[ approval.approver_username ]]</strong>
                                        <span v-if="approval.reviewed_at"> - [[ formatDate(approval.reviewed_at) ]]</span>
                                    </div>
                                    <div v-if="approval.review_notes" class="text-caption text--secondary mt-1">
                                        <v-icon x-small>mdi-note-text</v-icon>
                                        [[ approval.review_notes ]]
                                    </div>
                                    <v-divider v-if="index < allApprovals.length - 1" class="mt-2"></v-divider>
                                </div>
                            </v-card-text>
                        </v-card>
                    </v-col>
                </v-row>
                
                <!-- Review Actions (for approvers/project managers/admins) -->
                <v-row v-if="canApprove && assignment">
                    <v-col cols="12">
                        <v-card elevation="2">
                            <v-card-title class="orange darken-1 white--text">
                                <v-icon left dark>mdi-gavel</v-icon>
                                Review Actions
                            </v-card-title>
                            <v-card-text>
                                <!-- Show message if annotation approver but example not submitted -->
                                <v-alert v-if="userRole === 'annotation_approver' && assignment && assignment.status !== 'submitted'" type="info" text dense class="mb-4">
                                    <strong>‚ÑπÔ∏è Waiting for Submission:</strong> This example must be submitted by an annotator before you can review it.
                                </v-alert>
                                
                                <!-- Show message if project admin but approver hasn't approved yet -->
                                <v-alert v-else-if="userRole === 'project_admin' && !annotationApproverApproved" type="info" text dense class="mb-4">
                                    <strong>‚ÑπÔ∏è Waiting for Approver:</strong> This example must be approved by an annotation approver before you can review it.
                                </v-alert>
                                
                                <!-- Show message if project admin can review (approver has approved) -->
                                <v-alert v-else-if="annotationApproverApproved && userRole === 'project_admin'" type="warning" text dense class="mb-4">
                                    <strong>‚ö†Ô∏è Second-Level Review:</strong> This annotation has been approved by an annotation approver. As a project admin, you can review and approve or reject it.
                                </v-alert>
                                
                                <!-- Show message for approvers when submitted -->
                                <v-alert v-else-if="assignment && assignment.status === 'submitted'" type="info" text dense class="mb-4">
                                    <strong>‚ö†Ô∏è Ready for Review:</strong> This annotation is waiting for your approval or rejection.
                                </v-alert>
                                
                                <v-row>
                                    <v-col cols="12" sm="6">
                                        <v-btn
                                            block
                                            large
                                            color="success"
                                            :loading="approving"
                                            :disabled="!canReviewNow || approving || rejecting || (currentUserApproval && currentUserApproval.status === 'approved')"
                                            @click="approveExample"
                                        >
                                            <v-icon left>mdi-check-circle</v-icon>
                                            [[ currentUserApproval && currentUserApproval.status === 'approved' ? 'Already Approved' : 'Approve' ]]
                                        </v-btn>
                                    </v-col>
                                    <v-col cols="12" sm="6">
                                        <v-btn
                                            block
                                            large
                                            color="error"
                                            :loading="rejecting"
                                            :disabled="!canReviewNow || approving || rejecting || (currentUserApproval && currentUserApproval.status === 'rejected')"
                                            @click="rejectExample"
                                        >
                                            <v-icon left>mdi-close-circle</v-icon>
                                            [[ currentUserApproval && currentUserApproval.status === 'rejected' ? 'Already Rejected' : 'Reject' ]]
                                        </v-btn>
                                    </v-col>
                                </v-row>
                            </v-card-text>
                        </v-card>
                    </v-col>
                </v-row>
                
                <!-- Audio Player (for STT projects) -->
                <v-row v-if="example.filename && example.filename.includes('.wav')">
                    <v-col cols="12">
                        <v-card elevation="2">
                            <v-card-title class="green darken-1 white--text">
                                <v-icon left dark>mdi-volume-high</v-icon>
                                Audio
                            </v-card-title>
                            <v-card-text>
                                <audio
                                    ref="audioPlayer"
                                    :src="example.filename"
                                    controls
                                    loop
                                    class="audio-player"
                                    @play="audioPlaying = true"
                                    @pause="audioPlaying = false"
                                ></audio>
                                <div class="mt-2 text-caption text--secondary">
                                    <v-icon x-small>mdi-information</v-icon>
                                    Audio will loop automatically
                                </div>
                            </v-card-text>
                        </v-card>
                    </v-col>
                </v-row>
                
                <!-- Annotation Content -->
                <v-row>
                    <v-col cols="12">
                        <v-card elevation="2">
                            <v-card-title class="primary white--text">
                                <v-icon left dark>mdi-pencil</v-icon>
                                Annotation Content
                            </v-card-title>
                            <v-card-text>
                                <div class="annotation-content">
                                    <p class="text-h6 mb-4">Example #[[ example.id ]]</p>
                                    
                                    <div v-if="example.text">
                                        <div class="text-subtitle-2 mb-2">Text:</div>
                                        <p>[[ example.text ]]</p>
                                    </div>
                                    
                                    <div v-if="example.meta" class="mt-4">
                                        <div class="text-subtitle-2 mb-2">Metadata:</div>
                                        <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto;">[[ JSON.stringify(example.meta, null, 2) ]]</pre>
                                    </div>
                                    
                                    <v-divider class="my-4"></v-divider>
                                    
                                    <v-btn
                                        color="primary"
                                        :href="`/projects/{{ project_id }}/speech-to-text?page=${example.id}`"
                                        target="_blank"
                                    >
                                        <v-icon left>mdi-open-in-new</v-icon>
                                        Open in Doccano Annotation Interface
                                    </v-btn>
                                </div>
                            </v-card-text>
                        </v-card>
                    </v-col>
                </v-row>
                
                <!-- Navigation -->
                <v-row>
                    <v-col cols="12">
                        <v-card elevation="2">
                            <v-card-actions>
                                <v-btn color="secondary" :href="'/monlam/{{ project_id }}/dataset-enhanced/'">
                                    <v-icon left>mdi-table</v-icon>
                                    Back to Dataset
                                </v-btn>
                                <v-spacer></v-spacer>
                                <v-btn color="primary" :href="'/monlam/{{ project_id }}/completion/'">
                                    <v-icon left>mdi-chart-box</v-icon>
                                    Completion Dashboard
                                </v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-col>
                </v-row>
                
                <!-- Reject Dialog -->
                <v-dialog v-model="rejectDialog" max-width="500">
                    <v-card>
                        <v-card-title class="error white--text">Reject Annotation</v-card-title>
                        <v-card-text class="pt-4">
                            <v-textarea
                                v-model="rejectNotes"
                                label="Reason for rejection (required)"
                                placeholder="Please provide feedback for the annotator..."
                                rows="4"
                                outlined
                                :rules="[v => !!v || 'Reason is required']"
                            ></v-textarea>
                        </v-card-text>
                        <v-card-actions>
                            <v-spacer></v-spacer>
                            <v-btn text @click="rejectDialog = false">Cancel</v-btn>
                            <v-btn
                                color="error"
                                :disabled="!rejectNotes"
                                :loading="rejecting"
                                @click="rejectExample"
                            >
                                Reject
                            </v-btn>
                        </v-card-actions>
                    </v-card>
                </v-dialog>
                
                <!-- Success Snackbar -->
                <v-snackbar v-model="snackbar" :color="snackbarColor" :timeout="3000" top>
                    [[ snackbarText ]]
                    <template v-slot:action="{ attrs }">
                        <v-btn text v-bind="attrs" @click="snackbar = false">Close</v-btn>
                    </template>
                </v-snackbar>
            </v-container>
        </v-app>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
    new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        vuetify: new Vuetify({
            theme: {
                themes: {
                    light: {
                        primary: '#1976d2',
                        secondary: '#424242',
                    },
                },
            },
        }),
        data: {
            example: {{ example|safe }} || {},
            assignment: {{ assignment|safe }} || null,
            canApprove: {{ can_approve|yesno:"true,false" }},
            userRole: '{{ user_role|default:"" }}',
            allApprovals: {{ all_approvals|safe }} || [],
            annotationApproverApproved: {{ annotation_approver_approved|yesno:"true,false" }},
            projectAdminApproved: {{ project_admin_approved|yesno:"true,false" }},
            currentUserApproval: {{ current_user_approval|safe }} || null,
            canReviewNow: {{ can_review_now|yesno:"true,false" }},
            isSubmitted: {{ is_submitted|yesno:"true,false" }},
            approving: false,
            rejecting: false,
            rejectDialog: false,
            rejectNotes: '',
            audioPlaying: false,
            snackbar: false,
            snackbarText: '',
            snackbarColor: 'success',
        },
        mounted() {
            console.log('‚úÖ Annotation page mounted!');
            console.log('Example:', this.example);
            console.log('Assignment:', this.assignment);
            
            // Auto-play audio if it's an STT project
            this.$nextTick(() => {
                if (this.$refs.audioPlayer) {
                    this.$refs.audioPlayer.play().catch(e => {
                        console.log('Auto-play blocked, user must interact first');
                    });
                }
            });
        },
        methods: {
            getStatusColor(status) {
                const colors = {
                    'assigned': 'grey',
                    'in_progress': 'blue',
                    'submitted': 'orange',
                    'approved': 'green',
                    'rejected': 'red'
                };
                return colors[status] || 'grey';
            },
            getStatusIcon(status) {
                const icons = {
                    'assigned': 'mdi-clock-outline',
                    'in_progress': 'mdi-progress-clock',
                    'submitted': 'mdi-file-upload',
                    'approved': 'mdi-check-circle',
                    'rejected': 'mdi-close-circle'
                };
                return icons[status] || 'mdi-help-circle';
            },
            getApprovalColor(status) {
                if (status === 'approved') return 'green';
                if (status === 'rejected') return 'red';
                if (status === 'submitted') return 'orange';
                return 'grey';
            },
            getApprovalIcon(status) {
                if (status === 'approved') return 'mdi-check-circle';
                if (status === 'rejected') return 'mdi-close-circle';
                if (status === 'submitted') return 'mdi-clock-alert';
                return 'mdi-clock-outline';
            },
            getApprovalText(status) {
                if (status === 'approved') return 'APPROVED';
                if (status === 'rejected') return 'REJECTED';
                if (status === 'submitted') return 'PENDING REVIEW';
                return 'NOT SUBMITTED';
            },
            getRoleBadgeColor(assignment) {
                if (assignment.reviewed_by_role === 'project_manager') {
                    return 'purple';
                } else if (assignment.reviewed_by_role === 'approver') {
                    return 'orange darken-2';
                }
                return 'grey';
            },
            getRoleLabel(assignment) {
                if (assignment.reviewed_by_role === 'project_manager') {
                    return 'üëë PM FINAL';
                } else if (assignment.reviewed_by_role === 'approver') {
                    return '‚úì Approver';
                }
                return 'Reviewer';
            },
            formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            },
            getApprovalStatusColor(status) {
                if (status === 'approved') return 'green';
                if (status === 'rejected') return 'red';
                return 'grey';
            },
            getApprovalStatusIcon(status) {
                if (status === 'approved') return 'mdi-check-circle';
                if (status === 'rejected') return 'mdi-close-circle';
                return 'mdi-clock-outline';
            },
            async approveExample() {
                this.approving = true;
                
                try {
                    const response = await axios.post(
                        `/v1/projects/{{ project_id }}/assignments/approver-completion/{{ example_id }}/approve/`,
                        { notes: '' },
                        { headers: { 'X-CSRFToken': this.getCsrfToken() } }
                    );
                    
                    this.snackbarText = '‚úÖ Annotation approved successfully!';
                    this.snackbarColor = 'success';
                    this.snackbar = true;
                    
                    // Reload page after 1.5 seconds to show the snackbar
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } catch (err) {
                    console.error('Failed to approve:', err);
                    const errorData = err.response?.data || {};
                    const errorMsg = errorData.error || errorData.detail || err.message;
                    // Show specific message based on error type
                    if (errorData.requires_approver_approval || errorData.requires_submission) {
                        this.snackbarText = '‚ö†Ô∏è ' + errorMsg;
                        this.snackbarColor = 'warning';
                    } else {
                        this.snackbarText = '‚ùå Failed to approve: ' + errorMsg;
                        this.snackbarColor = 'error';
                    }
                    this.snackbar = true;
                    this.approving = false;
                }
            },
            showRejectDialog() {
                this.rejectNotes = '';
                this.rejectDialog = true;
            },
            async rejectExample() {
                // Remove the reject dialog requirement - just reject directly
                this.rejecting = true;
                this.rejectDialog = false;
                
                try {
                    const response = await axios.post(
                        `/v1/projects/{{ project_id }}/assignments/approver-completion/{{ example_id }}/reject/`,
                        { notes: '' },
                        { headers: { 'X-CSRFToken': this.getCsrfToken() } }
                    );
                    
                    this.snackbarText = '‚úó Annotation rejected. Annotator will see it again for revision.';
                    this.snackbarColor = 'warning';
                    this.snackbar = true;
                    
                    // Reload page after 1.5 seconds to show the snackbar
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } catch (err) {
                    console.error('Failed to reject:', err);
                    const errorData = err.response?.data || {};
                    const errorMsg = errorData.error || errorData.detail || err.message;
                    // Show specific message based on error type
                    if (errorData.requires_approver_approval || errorData.requires_submission) {
                        this.snackbarText = '‚ö†Ô∏è ' + errorMsg;
                        this.snackbarColor = 'warning';
                    } else {
                        this.snackbarText = '‚ùå Failed to reject: ' + errorMsg;
                        this.snackbarColor = 'error';
                    }
                    this.snackbar = true;
                    this.rejecting = false;
                }
            },
            getCsrfToken() {
                const name = 'csrftoken';
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [key, value] = cookie.trim().split('=');
                    if (key === name) return decodeURIComponent(value);
                }
                return '';
            },
        },
    });
    </script>
</body>
</html>



