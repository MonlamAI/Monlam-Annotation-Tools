<!doctype html>
<html>

<head>
  <meta data-n-head="1" charset="utf-8">
  <meta data-n-head="1" name="viewport" content="width=device-width,initial-scale=1">
  <meta data-n-head="1" data-hid="description" name="description"
    content="Monlam Tools - མོན་ལམ་ annotation tools for Tibetan language AI">
  <title>Monlam Tools</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon.png">
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon.png">
  <link rel="preload" href="/static/_nuxt/08fba5f.js" as="script">
  <link rel="preload" href="/static/_nuxt/132fcbd.js" as="script">
  <link rel="preload" href="/static/_nuxt/50aa8ea.js" as="script">
  <link rel="preload" href="/static/_nuxt/bd0aa1f.js" as="script">
  <style>
    /* Monlam Tools Custom Branding */
    :root {
      --monlam-gold: #B8963E;
      --monlam-gold-dark: #9A7B32;
      --monlam-navy: #1a1a2e;
      --monlam-font: 'MonlamTBslim', 'Noto Sans Tibetan', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .navbar.is-primary {
      background-color: var(--monlam-navy) !important;
    }

    .button.is-primary {
      background-color: var(--monlam-gold) !important;
      border-color: var(--monlam-gold) !important;
    }

    .button.is-primary:hover {
      background-color: var(--monlam-gold-dark) !important;
    }

    a.has-text-primary {
      color: var(--monlam-gold) !important;
    }

    .tag.is-primary {
      background-color: var(--monlam-gold) !important;
    }

    .menu-list a.is-active {
      background-color: var(--monlam-gold) !important;
    }

    .progress.is-primary::-webkit-progress-value {
      background-color: var(--monlam-gold) !important;
    }

    .tabs.is-toggle li.is-active a {
      background-color: var(--monlam-gold) !important;
      border-color: var(--monlam-gold) !important;
    }

    .pagination-link.is-current {
      background-color: var(--monlam-gold) !important;
      border-color: var(--monlam-gold) !important;
    }

    /* Hide GitHub button and link */
    a[href*="github.com"],
    a[href*="GITHUB"],
    button[class*="github"],
    .github-button {
      display: none !important;
    }

    /* ========================================
         MonlamTBslim FONT - Roboto deleted from build
         ======================================== */

    /* Primary MonlamTBslim font-face */
    @font-face {
      font-family: 'MonlamTBslim';
      src: local('MonlamTBslim'),
        url('/static/fonts/MonlamTBslim.woff2') format('woff2'),
        url('/static/fonts/MonlamTBslim.woff') format('woff'),
        url('/static/fonts/MonlamTBslim.ttf') format('truetype');
      font-weight: 100 900;
      font-style: normal;
      font-display: swap;
    }

    /* Roboto fallback - when Roboto is requested, use MonlamTBslim */
    @font-face {
      font-family: 'Roboto';
      src: local('MonlamTBslim'),
        url('/static/fonts/MonlamTBslim.woff2') format('woff2'),
        url('/static/fonts/MonlamTBslim.woff') format('woff'),
        url('/static/fonts/MonlamTBslim.ttf') format('truetype');
      font-weight: 100 900;
      font-style: normal;
      font-display: swap;
    }

    /* Apply MonlamTBslim everywhere */
    *,
    *::before,
    *::after {
      font-family: var(--monlam-font) !important;
    }

    /* Fix Tibetan vowel marks (ི ུ) being cut off - need extra line-height */
    html,
    html body,
    html body *,
    .v-application,
    .v-application *,
    .v-btn,
    .v-list-item,
    .v-menu__content,
    .v-select__selection,
    .v-toolbar__title,
    .v-tab,
    label,
    span,
    p,
    div,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      line-height: 1.8 !important;
    }

    /* Extra padding for menu items and buttons */
    .v-btn {
      padding-top: 4px !important;
      padding-bottom: 4px !important;
      min-height: 40px !important;
    }

    .v-list-item {
      min-height: 48px !important;
      padding-top: 8px !important;
      padding-bottom: 8px !important;
    }

    .v-tab {
      padding-top: 8px !important;
      padding-bottom: 8px !important;
    }

    .v-chip {
      height: auto !important;
      min-height: 32px !important;
      padding-top: 4px !important;
      padding-bottom: 4px !important;
    }

    .v-text-field input,
    .v-text-field textarea {
      padding-top: 8px !important;
      padding-bottom: 8px !important;
      line-height: 1.8 !important;
    }

  </style>
</head>

<body>
  <div id="__nuxt">
    <style>
      #nuxt-loading {
        background: #fff;
        visibility: hidden;
        opacity: 0;
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        animation: nuxtLoadingIn 10s ease;
        -webkit-animation: nuxtLoadingIn 10s ease;
        animation-fill-mode: forwards;
        overflow: hidden
      }

      @keyframes nuxtLoadingIn {
        0% {
          visibility: hidden;
          opacity: 0
        }

        20% {
          visibility: visible;
          opacity: 0
        }

        100% {
          visibility: visible;
          opacity: 1
        }
      }

      @-webkit-keyframes nuxtLoadingIn {
        0% {
          visibility: hidden;
          opacity: 0
        }

        20% {
          visibility: visible;
          opacity: 0
        }

        100% {
          visibility: visible;
          opacity: 1
        }
      }

      #nuxt-loading>div,
      #nuxt-loading>div:after {
        border-radius: 50%;
        width: 5rem;
        height: 5rem
      }

      #nuxt-loading>div {
        font-size: 10px;
        position: relative;
        text-indent: -9999em;
        border: .5rem solid #f5f5f5;
        border-left: .5rem solid #B8963E;
        -webkit-transform: translateZ(0);
        -ms-transform: translateZ(0);
        transform: translateZ(0);
        -webkit-animation: nuxtLoading 1.1s infinite linear;
        animation: nuxtLoading 1.1s infinite linear
      }

      #nuxt-loading.error>div {
        border-left: .5rem solid #ff4500;
        animation-duration: 5s
      }

      @-webkit-keyframes nuxtLoading {
        0% {
          -webkit-transform: rotate(0);
          transform: rotate(0)
        }

        100% {
          -webkit-transform: rotate(360deg);
          transform: rotate(360deg)
        }
      }

      @keyframes nuxtLoading {
        0% {
          -webkit-transform: rotate(0);
          transform: rotate(0)
        }

        100% {
          -webkit-transform: rotate(360deg);
          transform: rotate(360deg)
        }
      }
    </style>
    <script>window.addEventListener("error", function () { var e = document.getElementById("nuxt-loading"); e && (e.className += " error") })</script>
    <div id="nuxt-loading" aria-live="polite" role="status">
      <div>Loading...</div>
    </div>
  </div>
  <script>window.__NUXT__ = { config: { _app: { basePath: "/", assetsPath: "/static/_nuxt/", cdnURL: null } } }</script>
  <script>
    // Tibetan translations for Monlam Tools (Doccano)
    const translations = {
      // Home page
      'Text Annotation for Humans': 'ཞུ་དག་བྱ་ཡུལ།',
      'Get Started': 'འགོ་བརྩམས།',
      'GET STARTED': 'འགོ་བརྩམས།',
      'The best features': 'དམིགས་བསལ་ཁྱད་ཆོས།',
      'Team Collaboration': 'ཚོགས་པའི་མཉམ་ལས།',
      'Annotation with your team mates': 'ཁྱོད་ཀྱི་ལས་རོགས་དང་མཉམ་དུ་མཆན་འགོད།',
      'Any Language': 'སྐད་རིགས་གང་ཡང་།',
      'Annotation with any language': 'སྐད་རིགས་གང་ཡང་རུང་བའི་མཆན་འགོད།',
      'Open Source': 'ལས་སླ་པོ།',
      'Annotation that is free and customizable': 'རིན་མེད་དང་རང་མོས་བཟོ་བཅོས་བྱེད་རུང་བའི་མཆན་འགོད།',
      'Realize your ideas quickly': 'ཁྱོད་ཀྱི་བསམ་བློ་མགྱོགས་པོར་དངོས་སུ་སྒྲུབ།',
      'Try Demo': 'ཚོད་ལྟ་བྱེད།',
      'TRY DEMO': 'ཚོད་ལྟ་བྱེད།',

      // Navigation
      'Login': 'ནང་འཛུལ།',
      'LOGIN': 'ནང་འཛུལ།',
      'Sign Out': 'ཕྱིར་འཐོན།',
      'Projects': 'ལས་གཞི།',
      'PROJECTS': 'ལས་གཞི།',

      // Project home
      'Home': 'མདུན་ངོས།',
      'Welcome to Doccano!': 'སྐུ་ཁམས་བཟང་།',
      'Welcome to Monlam Tools!': 'སྐུ་ཁམས་བཟང་།',
      'Import a dataset': 'གཞི་གྲངས་ནང་འདྲེན།',
      'Create labels for this project': 'ལས་གཞི་འདིའི་ཆེད་ཁ་བྱང་གསར་བཟོ།',
      'Add members for collaborative work': 'མཉམ་ལས་ཀྱི་ཆེད་ཚོགས་མི་སྣོན་པ།',
      'Define a guideline for the work': 'ལས་ཀའི་ལམ་སྟོན་གཏན་འཁེལ།',
      'Annotate the dataset': 'གཞི་གྲངས་ལ་མཆན་འགོད།',
      'View statistics': 'ཚད་གཞི་ལྟ་བ།',
      'Export the dataset': 'གཞི་གྲངས་ཕྱིར་འདྲེན།',

      // Common
      'Save': 'ཉར་ཚགས།',
      'Edit': 'རྩོམ་སྒྲིག',
      'Create': 'གསར་བཟོ།',
      'Cancel': 'འདོར་བ།',
      'Close': 'སྒོ་རྒྱག',
      'Delete': 'བསུབ་པ།',
      'Search': 'བཙལ་ཞིབ།',
      'Import': 'ནང་འདྲེན།',
      'Export': 'ཕྱིར་འདྲེན།',
      'Add': 'སྣོན་པ།',
      'Upload': 'སྐྱེལ་འཇུག',
      'Yes': 'ཡིན།',
      'No': 'མིན།',
      'Loading...': 'སྣན་བཞིན་པ།...',
      'Loading... Please wait': 'སྣན་བཞིན་པ། སྒུག་རོགས།',
      

      // Labels/Annotation
      'Labels': 'ཁ་བྱང་།',
      'Dataset': 'གཞི་གྲངས།',
      'Members': 'ཚོགས་མི།',
      'Guideline': 'ལམ་སྟོན།',
      'Statistics': 'ཚད་གཞི།',
      'Metrics': 'ཚད་གཞི།',
      'Settings': 'སྒྲིག་འགོད།',
      'Comments': 'མཆན།',

      // Demo types
      'Named Entity Recognition': 'མིང་ཚིག་དབྱེ་འབྱེད།',
      'Sentiment Analysis': 'སེམས་ཚོར་དབྱེ་ཞིབ།',
      'Translation': 'ཡིག་སྒྱུར།',
      'Text to SQL': 'ཡི་གེ་ནས་SQL',
      'Intent Detection and Slot Filling': 'དམིགས་བསལ་འཚོལ་ཞིབ།',
      'Image Classification': 'པར་རིས་དབྱེ་འབྱེད།',
      'Image Captioning': 'པར་རིས་འགྲེལ་བཤད།',
      'Object Detection': 'དངོས་པོ་འཚོལ་ཞིབ།',
      'Polygon Segmentation': 'མཐའ་རིས་དབྱེ་བཞག',
      'Speech to Text': 'སྐད་ཆ་ནས་ཡི་གེ།',

      // Project types
      'Text Classification': 'ཡི་གེ་དབྱེ་འབྱེད།',
      'Sequence Labeling': 'མཚམས་རིས་ཁ་བྱང་།',
      'Sequence to sequence': 'མཚམས་ནས་མཚམས།',

      // Doccano branding
      'doccano': 'Monlam Tools',
      'Doccano': 'Monlam Tools',
      'Monlam AI': 'Monlam Tools',

      // Copyright - fix year to 2026
      '© 2025 Monlam Tools': '© 2026 Monlam Tools',
      '© 2026 Monlam AI': '© 2026 Monlam Tools',

    };

    document.addEventListener('DOMContentLoaded', function () {
      // Update title
      document.title = 'Monlam Tools';

      // ========================================
      // Force Monlam favicon (override any Nuxt.js defaults)
      // ========================================
      function setFavicon() {
        // Remove existing favicons
        document.querySelectorAll('link[rel*="icon"]').forEach(function (link) {
          if (!link.href.includes('favicon.ico') && !link.href.includes('favicon.png')) {
            link.remove();
          }
        });

        // Ensure our favicon links exist
        const head = document.head;
        const existingIco = document.querySelector('link[href="/favicon.ico"]');
        if (!existingIco) {
          const ico = document.createElement('link');
          ico.rel = 'icon';
          ico.type = 'image/x-icon';
          ico.href = '/favicon.ico';
          head.appendChild(ico);
        }
      }
      setFavicon();

      function replaceText(element) {
        // Update title dynamically
        if (document.title.includes('doccano')) {
          document.title = 'Monlam Tools';
        }

        // Walk through all text nodes
        const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
        let node;
        while (node = walker.nextNode()) {
          let text = node.nodeValue;
          let changed = false;

          // Check each translation
          for (const [eng, tib] of Object.entries(translations)) {
            if (text.includes(eng)) {
              text = text.replace(new RegExp(eng.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), tib);
              changed = true;
            }
          }

          if (changed) {
            node.nodeValue = text;
          }
        }
      }

      // Observe DOM changes
      const observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
          if (mutation.type === 'childList') {
            mutation.addedNodes.forEach(function (node) {
              if (node.nodeType === Node.ELEMENT_NODE) {
                replaceText(node);
              }
            });
          }
        });
      });

      observer.observe(document.body, { childList: true, subtree: true });

      // Initial replacement
      replaceText(document.body);

      // Periodic check
      setInterval(function () {
        replaceText(document.body);
        // Remove GitHub buttons/links
        document.querySelectorAll('a[href*="github"], button').forEach(function (el) {
          if (el.textContent.toLowerCase().includes('github')) {
            el.style.display = 'none';
          }
        });
      }, 1000);

      // ========================================
      // Review Button Styling: Red O / Green Check
      // ========================================
      const CLOSE_PATH = "M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z";
      const CHECK_PATH = "M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z";
      const CIRCLE_PATH = "M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z";

      function styleReviewButtons() {
        document.querySelectorAll('.v-btn--icon .v-icon svg path').forEach(function (path) {
          const d = path.getAttribute('d');
          // X icon -> Red Circle
          if (d === CLOSE_PATH) {
            path.setAttribute('d', CIRCLE_PATH);
            path.style.fill = '#f44336';
          }
          // Check icon -> Green
          else if (d === CHECK_PATH) {
            path.style.fill = '#4caf50';
          }
        });
      }

      // Run periodically to catch dynamic updates
      setInterval(styleReviewButtons, 500);
      styleReviewButtons();

      // ========================================
      // FORCE MonlamTBslim font - override Vuetify's runtime Roboto injection
      // ========================================
      const MONLAM_FONT = "'MonlamTBslim', 'Noto Sans Tibetan', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";

      function forceMonlamFont() {
        // Override on html and body elements
        document.documentElement.style.setProperty('font-family', MONLAM_FONT, 'important');
        document.body.style.setProperty('font-family', MONLAM_FONT, 'important');

        // Override on v-application (Vuetify root)
        document.querySelectorAll('.v-application').forEach(function (el) {
          el.style.setProperty('font-family', MONLAM_FONT, 'important');
        });

        // Override all elements that Vuetify typically styles
        document.querySelectorAll('h1, h2, h3, h4, h5, h6, .display-1, .display-2, .headline, .title, .subtitle-1, .subtitle-2, .body-1, .body-2, .v-btn, .v-card, .v-list-item, .v-toolbar__title, .v-tab, span, p, div, label, input, textarea').forEach(function (el) {
          el.style.setProperty('font-family', MONLAM_FONT, 'important');
          el.style.setProperty('line-height', '1.8', 'important');
        });
      }

      // Run immediately and frequently to override Vuetify
      forceMonlamFont();
      setInterval(forceMonlamFont, 500);

      // Also run after page fully loads
      window.addEventListener('load', function () {
        forceMonlamFont();
        setTimeout(forceMonlamFont, 100);
        setTimeout(forceMonlamFont, 500);
        setTimeout(forceMonlamFont, 1000);
      });


    });
  </script>
  <script src="/static/_nuxt/08fba5f.js"></script>
  <script src="/static/_nuxt/132fcbd.js"></script>
  <script src="/static/_nuxt/50aa8ea.js"></script>
  <script src="/static/_nuxt/bd0aa1f.js"></script>
  
  <!-- FIX: Patch role translation for project_manager -->
  <script>
  (function() {
    'use strict';
    
    // Role translation map
    const ROLE_MAP = {
      'project_admin': 'Project Admin',
      'annotator': 'Annotator', 
      'annotation_approver': 'Annotation Approver',
      'project_manager': 'Project Manager'
    };
    
    // Method 1: Intercept role API responses and add translatedName
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
      return originalFetch.apply(this, args).then(response => {
        const url = args[0];
        if (typeof url === 'string' && url.includes('/v1/roles')) {
          const clonedResponse = response.clone();
          clonedResponse.json().then(data => {
            // Data might be array or {results: array}
            const roles = Array.isArray(data) ? data : (data.results || []);
            roles.forEach(role => {
              if (role.name && !role.translatedName) {
                role.translatedName = ROLE_MAP[role.name] || 
                  role.name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
              }
            });
          }).catch(() => {});
        }
        return response;
      });
    };
    
    // Method 2: Fix role dropdown text everywhere
    function fixRoleDropdown() {
      // Valid role names that should NOT be replaced
      const validRoles = ['Project Admin', 'Annotator', 'Annotation Approver', 'Project Manager',
                          'project_admin', 'annotator', 'annotation_approver', 'project_manager'];
      
      // Patterns that indicate "undefined" role (project_manager showing incorrectly)
      const undefinedPatterns = [
        'undefined',
        'Undefined', 
        'No Role Defined',
        'Role Defined',
        'མིན།',  // Tibetan "no/not" - translation of "undefined"
      ];
      
      // Helper to check if text needs fixing
      function needsFix(text) {
        // If it's already a valid role, don't fix
        if (validRoles.some(role => text === role)) return false;
        // If it contains undefined patterns, fix it
        if (undefinedPatterns.some(pattern => text.includes(pattern))) return true;
        // If text is exactly "མིན།" or variations
        if (text.startsWith('མིན།')) return true;
        return false;
      }
      
      // Fix in list items (dropdowns)
      document.querySelectorAll('.v-list-item__title, .v-list-item__content, .v-select__selection, .v-chip__content, .v-select__selection-text').forEach(function(item) {
        const text = item.textContent.trim();
        
        if (needsFix(text)) {
          // For elements that directly contain the text
          if (item.childNodes.length <= 2) {
            const oldText = item.textContent;
            item.textContent = 'Project Manager';
            console.log('[Monlam] Fixed role: "' + oldText + '" → "Project Manager"');
          }
        }
      });
      
      // Also fix in select/autocomplete dropdowns that may show role options
      document.querySelectorAll('.v-menu__content .v-list-item').forEach(function(item) {
        const titleEl = item.querySelector('.v-list-item__title');
        if (titleEl) {
          const text = titleEl.textContent.trim();
          if (needsFix(text)) {
            const oldText = titleEl.textContent;
            titleEl.textContent = 'Project Manager';
            console.log('[Monlam] Fixed dropdown role: "' + oldText + '" → "Project Manager"');
          }
        }
      });
      
      // Extra: Fix any element that exactly shows the broken pattern
      document.querySelectorAll('*').forEach(function(el) {
        if (el.children.length === 0 && el.textContent) {
          const text = el.textContent.trim();
          // Very specific match for the broken display
          if (text === 'མིན། Role Defined' || text === 'མིན།' || text === 'མིན། role defined') {
            el.textContent = 'Project Manager';
            console.log('[Monlam] Fixed exact match: "' + text + '" → "Project Manager"');
          }
        }
      });
    }
    
    // Run on page load and when dropdown opens
    document.addEventListener('DOMContentLoaded', fixRoleDropdown);
    
    // Watch for dropdown to open
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.addedNodes.length > 0) {
          setTimeout(fixRoleDropdown, 50);
          setTimeout(fixRoleDropdown, 200);  // Double check after Vue updates
        }
      });
    });
    observer.observe(document.body, { childList: true, subtree: true });
    
    // Also run periodically when on members page
    setInterval(function() {
      if (window.location.pathname.includes('/members')) {
        fixRoleDropdown();
      }
    }, 1000);
    
    // Safety net: Fix broken translation patterns (only if translation file fails)
    // This should rarely be needed if translation files are correct
    function fixBrokenTranslations() {
      const fixes = {
        'མིན།t བཅོས་ཟིན་པ།': 'ཞིབ་བཤེར་མ་བྱས་པ།',
        'མིན།t གྲུབ་ཟིན་པ།': 'མ་གྲུབ།',
        'མིན།t': 'མིན།'
      };
      
      document.querySelectorAll('*').forEach(function(el) {
        if (el.children.length === 0 && el.textContent) {
          let text = el.textContent;
          let changed = false;
          
          for (const [broken, fixed] of Object.entries(fixes)) {
            if (text.includes(broken)) {
              text = text.replace(broken, fixed);
              changed = true;
            }
          }
          
          if (changed) {
            console.log('[Monlam] Fixed broken translation:', el.textContent, '→', text);
            el.textContent = text;
          }
        }
      });
    }
    
    // Run fix periodically (as safety net only)
    setInterval(fixBrokenTranslations, 1000);
    
    // Expose globally for debugging
    window.fixRoleDropdown = fixRoleDropdown;
    window.fixBrokenTranslations = fixBrokenTranslations;
    
    console.log('[Monlam] Role translation fix loaded');
  })();
  </script>
  
  <!-- Monlam Features - Inline for Maximum Reliability -->
  <script>
(function() {
    'use strict';
    
    console.log('[Monlam Inline] Features loading...');
    
    // NOTE: $translateRole fix is now applied immediately after Vue loads (above)
    
    const CONFIG = {
        maxRetries: 50,
        retryDelay: 200,
        projectId: null
    };
    
    // UTILITIES
    function getProjectId() {
        const match = window.location.pathname.match(/\/projects\/(\d+)/);
        return match ? match[1] : null;
    }
    
    function waitForElement(selector, callback, retries = 0) {
        const element = document.querySelector(selector);
        if (element) {
            console.log(`[Monlam] Found element: ${selector}`);
            callback(element);
        } else if (retries < CONFIG.maxRetries) {
            setTimeout(() => waitForElement(selector, callback, retries + 1), CONFIG.retryDelay);
        } else {
            console.log(`[Monlam] Timeout waiting for: ${selector}`);
        }
    }
    
    function waitForElements(selector, callback, retries = 0) {
        const elements = document.querySelectorAll(selector);
        if (elements.length > 0) {
            console.log(`[Monlam] Found ${elements.length} elements: ${selector}`);
            callback(elements);
        } else if (retries < CONFIG.maxRetries) {
            setTimeout(() => waitForElements(selector, callback, retries + 1), CONFIG.retryDelay);
        }
    }
    
    // FEATURE 1: AUDIO AUTO-LOOP (ONLY on annotation pages)
    let audioObserver = null;
    
    function isOnAnnotationPage() {
        const path = window.location.pathname;
        // Dataset page = NO loop
        if (path.includes('/dataset')) return false;
        // Metrics/completion pages = NO loop
        if (path.includes('/metrics') || path.includes('/completion')) return false;
        // Members page = NO loop  
        if (path.includes('/members')) return false;
        // Settings = NO loop
        if (path.includes('/settings')) return false;
        // Labels = NO loop
        if (path.includes('/labels')) return false;
        
        // Only these specific annotation task types get loop
        return path.includes('/speech-to-text') || 
               path.includes('/sequence-labeling') ||
               path.includes('/text-classification') ||
               path.includes('/seq2seq') ||
               path.includes('/image-classification') ||
               path.includes('/bounding-box') ||
               path.includes('/segmentation') ||
               path.includes('/image-captioning');
    }
    
    function stopAllAudio() {
        document.querySelectorAll('audio').forEach(audio => {
            audio.pause();
            audio.currentTime = 0;
            audio.loop = false;
            audio.autoplay = false;
            audio.removeAttribute('data-monlam-loop');
        });
    }
    
    function enableAudioLoop() {
        // ALWAYS disconnect previous observer first
        if (audioObserver) {
            audioObserver.disconnect();
            audioObserver = null;
        }
        
        // Check page type
        const shouldEnableLoop = isOnAnnotationPage();
        
        if (!shouldEnableLoop) {
            // NOT on annotation page - stop all audio
            console.log('[Monlam Audio] Not on annotation page, stopping audio');
            stopAllAudio();
            return;
        }
        
        console.log('[Monlam Audio] On annotation page, enabling loop...');
        
        function applyLoop(audio) {
            // Double-check we're still on annotation page (SPA navigation might have happened)
            if (!isOnAnnotationPage()) {
                stopAllAudio();
                return;
            }
            
            if (!audio.hasAttribute('data-monlam-loop')) {
                audio.loop = true;
                audio.setAttribute('data-monlam-loop', 'true');
                
                if (audio.readyState >= 2) {
                    audio.play().catch(e => {
                        console.log('[Monlam Audio] Auto-play blocked, waiting for user click');
                    });
                } else {
                    audio.addEventListener('canplay', () => {
                        // Check again before playing
                        if (isOnAnnotationPage()) {
                            audio.play().catch(() => {});
                        }
                    }, { once: true });
                }
            }
        }
        
        // Wait for audio element to appear, then apply loop
        waitForElements('audio', (audioElements) => {
            if (isOnAnnotationPage()) {
                audioElements.forEach(applyLoop);
            }
        });
        
        // Observer for dynamically added audio (only on annotation pages)
        audioObserver = new MutationObserver(() => {
            if (isOnAnnotationPage()) {
                document.querySelectorAll('audio:not([data-monlam-loop])').forEach(applyLoop);
            } else {
                // If we navigated away, stop everything
                stopAllAudio();
                if (audioObserver) {
                    audioObserver.disconnect();
                    audioObserver = null;
                }
            }
        });
        audioObserver.observe(document.body, { childList: true, subtree: true });
    }
    
    // FEATURE: APPROVE/REJECT BUTTONS FOR REVIEWERS
    async function addApproveRejectButtons() {
        const path = window.location.pathname;
        const isAnnotationPage = path.includes('/speech-to-text') || 
                                  path.includes('/sequence-labeling') ||
                                  path.includes('/document-classification') ||
                                  path.includes('/seq2seq') ||
                                  path.includes('/intent-detection-and-slot-filling') ||
                                  path.includes('/image-classification') ||
                                  path.includes('/bounding-box') ||
                                  path.includes('/segmentation') ||
                                  path.includes('/image-captioning');
        
        // CLEANUP: Remove buttons when NOT on annotation page
        if (!isAnnotationPage) {
            const existingButtons = document.querySelector('.monlam-approve-buttons');
            if (existingButtons) {
                existingButtons.remove();
                console.log('[Monlam Approve] Removed buttons (not on annotation page)');
            }
            // REMOVED: Lock indicator cleanup - No longer needed
            return;
        }
        
        console.log('[Monlam Approve] On annotation page, checking user role...');
        
        try {
            // Get project ID
            const projectMatch = path.match(/\/projects\/(\d+)/);
            if (!projectMatch) return;
            const projectId = projectMatch[1];
            
            // Use /my-role API (accessible to all users, unlike /members)
            const myRoleResp = await fetch(`/v1/projects/${projectId}/my-role`);
            if (!myRoleResp.ok) {
                console.log('[Monlam Approve] Cannot get role, status:', myRoleResp.status);
                return;
            }
            const myRoleData = await myRoleResp.json();
            const roleName = (myRoleData.rolename || myRoleData.role || '').toLowerCase();
            
            console.log('[Monlam Approve] My role:', roleName, 'Data:', myRoleData);
            
            // Check for approver/PM/admin roles (case-insensitive, flexible matching)
            const isApprover = 
                roleName.includes('approver') || 
                roleName.includes('approval') ||
                roleName.includes('manager') || 
                roleName.includes('admin') ||
                roleName === 'annotation_approver' ||
                roleName === 'project_manager' ||
                roleName === 'project_admin';
            
            if (!isApprover) {
                console.log('[Monlam Approve] User is not an approver/PM/admin, skipping buttons');
                return;
            }
            
            console.log('[Monlam Approve] User IS an approver/PM/admin, creating buttons');
            // Continue with button creation
            createApproveRejectButtons(projectId, roleName);
        } catch (error) {
            console.error('[Monlam Approve] Error in addApproveRejectButtons:', error);
        }
        
        function createApproveRejectButtons(projectId, roleName) {
            try {
                
                // Wait for the main content area to appear
                waitForElement('main', (mainElement) => {
                if (document.querySelector('.monlam-approve-buttons')) {
                    console.log('[Monlam Approve] Buttons already exist');
                    return;
                }
                
                // Get current example ID from the page
                function getCurrentExampleId() {
                    // Method 1: Check Vue app state
                    if (window.$nuxt && window.$nuxt.$store && window.$nuxt.$store.state) {
                        const state = window.$nuxt.$store.state;
                        // Check various possible locations in the state
                        if (state.example && state.example.id) {
                            console.log('[Monlam Approve] Found example ID in $nuxt.$store.state.example:', state.example.id);
                            return state.example.id;
                        }
                        if (state.examples && state.examples.current && state.examples.current.id) {
                            console.log('[Monlam Approve] Found example ID in $nuxt.$store.state.examples.current:', state.examples.current.id);
                            return state.examples.current.id;
                        }
                    }
                    
                    // Method 2: Check __NUXT__ (server-side rendered state)
                    if (window.__NUXT__ && window.__NUXT__.state) {
                        const state = window.__NUXT__.state;
                        if (state.example && state.example.id) {
                            console.log('[Monlam Approve] Found example ID in __NUXT__.state.example:', state.example.id);
                            return state.example.id;
                        }
                    }
                    
                    // Method 3: Look for data attributes in DOM
                    const exampleEl = document.querySelector('[data-example-id]');
                    if (exampleEl) {
                        const id = exampleEl.getAttribute('data-example-id');
                        console.log('[Monlam Approve] Found example ID in DOM attribute:', id);
                        return id;
                    }
                    
                    // Method 4: Parse from API calls in network tab (last resort)
                    // Check if there's a recent fetch to examples API
                    if (window.performance) {
                        const entries = performance.getEntriesByType('resource');
                        const exampleApiCalls = entries.filter(e => e.name.includes('/examples/'));
                        if (exampleApiCalls.length > 0) {
                            const lastCall = exampleApiCalls[exampleApiCalls.length - 1];
                            const match = lastCall.name.match(/\/examples\/(\d+)/);
                            if (match) {
                                console.log('[Monlam Approve] Found example ID from API call:', match[1]);
                                return match[1];
                            }
                        }
                    }
                    
                    console.warn('[Monlam Approve] Could not find example ID');
                    return null;
                }
                
                // Create buttons container
                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'monlam-approve-buttons';
                buttonsContainer.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    display: flex;
                    gap: 12px;
                    z-index: 1000;
                    padding: 12px;
                    background: white;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                `;
                
                // Approve button
                const approveBtn = document.createElement('button');
                approveBtn.textContent = '✓ Approve';
                approveBtn.className = 'monlam-approve-btn';
                approveBtn.style.cssText = `
                    padding: 10px 20px;
                    background: #4caf50;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s;
                `;
                approveBtn.onmouseover = () => approveBtn.style.background = '#45a049';
                approveBtn.onmouseout = () => approveBtn.style.background = '#4caf50';
                
                // Reject button
                const rejectBtn = document.createElement('button');
                rejectBtn.textContent = '✗ Reject';
                rejectBtn.className = 'monlam-reject-btn';
                rejectBtn.style.cssText = `
                    padding: 10px 20px;
                    background: #f44336;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s;
                `;
                rejectBtn.onmouseover = () => rejectBtn.style.background = '#da190b';
                rejectBtn.onmouseout = () => rejectBtn.style.background = '#f44336';
                
                // Status display
                const statusDisplay = document.createElement('div');
                statusDisplay.className = 'monlam-status-display';
                statusDisplay.style.cssText = `
                    padding: 10px 16px;
                    background: #e3f2fd;
                    border-radius: 6px;
                    font-size: 13px;
                    color: #1976d2;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                `;
                statusDisplay.innerHTML = '<span style="font-weight: 600;">Status:</span><span class="status-text">Loading...</span>';
                
                // Get CSRF token
                function getCsrfToken() {
                    // Try cookie first (most reliable)
                    const cookies = document.cookie.split(';');
                    for (const cookie of cookies) {
                        const [name, value] = cookie.trim().split('=');
                        if (name === 'csrftoken') return value;
                    }
                    // Fallback to input field
                    const token = document.querySelector('[name=csrfmiddlewaretoken]');
                    return token ? token.value : '';
                }
                
                // Update status display
                async function updateStatus() {
                    const exampleId = getCurrentExampleId();
                    if (!exampleId) {
                        statusDisplay.querySelector('.status-text').textContent = 'No example loaded';
                        return;
                    }
                    
                    try {
                        const resp = await fetch(`/v1/projects/${projectId}/tracking/${exampleId}/status/`);
                        const data = await resp.json();
                        
                        const statusText = statusDisplay.querySelector('.status-text');
                        
                        // Color code status
                        const statusColors = {
                            'pending': '#9e9e9e',
                            'in_progress': '#2196f3',
                            'submitted': '#ff9800',
                            'approved': '#4caf50',
                            'rejected': '#f44336'
                        };
                        statusDisplay.style.background = statusColors[data.status] ? statusColors[data.status] + '20' : '#e3f2fd';
                        statusDisplay.style.color = statusColors[data.status] || '#1976d2';
                        
                        // Build detailed status text
                        let statusInfo = data.status.toUpperCase();
                        
                        // Show who reviewed (for approved/rejected)
                        if (data.status === 'approved' && data.reviewed_by) {
                            statusInfo = `✅ APPROVED by ${data.reviewed_by}`;
                            if (data.reviewed_at) {
                                const reviewDate = new Date(data.reviewed_at).toLocaleDateString();
                                statusInfo += ` on ${reviewDate}`;
                            }
                        } else if (data.status === 'rejected' && data.reviewed_by) {
                            statusInfo = `❌ REJECTED by ${data.reviewed_by}`;
                            if (data.reviewed_at) {
                                const reviewDate = new Date(data.reviewed_at).toLocaleDateString();
                                statusInfo += ` on ${reviewDate}`;
                            }
                            if (data.review_notes) {
                                statusInfo += ` - "${data.review_notes}"`;
                            }
                        }
                        // For submitted/pending statuses, just show the status without annotator name
                        
                        statusText.textContent = statusInfo;
                    } catch (error) {
                        console.error('[Monlam Approve] Error fetching status:', error);
                        statusDisplay.querySelector('.status-text').textContent = 'Error loading status';
                    }
                }
                
                // Approve handler - NO notes required, NO popup
                approveBtn.onclick = async () => {
                    const exampleId = getCurrentExampleId();
                    if (!exampleId) {
                        // Show subtle notification instead of alert
                        const notification = document.createElement('div');
                        notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ff9800; color: white; padding: 12px 20px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10000;';
                        notification.textContent = 'Cannot find example ID. Please ensure an example is loaded.';
                        document.body.appendChild(notification);
                        setTimeout(() => notification.remove(), 3000);
                        return;
                    }
                    
                    // Approve directly without asking for notes
                    try {
                        approveBtn.disabled = true;
                        approveBtn.textContent = 'Approving...';
                        
                        const resp = await fetch(`/v1/projects/${projectId}/tracking/${exampleId}/approve/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCsrfToken()
                            },
                            body: JSON.stringify({ review_notes: '' })
                        });
                        
                        const data = await resp.json();
                        
                        if (resp.ok) {
                            // Show subtle notification instead of alert
                            const notification = document.createElement('div');
                            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4caf50; color: white; padding: 12px 20px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10000;';
                            notification.textContent = '✅ Example approved successfully!';
                            document.body.appendChild(notification);
                            setTimeout(() => notification.remove(), 2000);
                            updateStatus();
                        } else {
                            // Show error notification instead of alert
                            const notification = document.createElement('div');
                            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #f44336; color: white; padding: 12px 20px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10000;';
                            notification.textContent = '❌ ' + (data.error || 'Unknown error');
                            document.body.appendChild(notification);
                            setTimeout(() => notification.remove(), 4000);
                        }
                    } catch (error) {
                        // Show error notification instead of alert
                        const notification = document.createElement('div');
                        notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #f44336; color: white; padding: 12px 20px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10000;';
                        notification.textContent = '❌ Network error: ' + error.message;
                        document.body.appendChild(notification);
                        setTimeout(() => notification.remove(), 4000);
                    } finally {
                        approveBtn.disabled = false;
                        approveBtn.textContent = '✓ Approve';
                    }
                };
                
                // Reject handler - no prompt, direct action, NO popup
                rejectBtn.onclick = async () => {
                    const exampleId = getCurrentExampleId();
                    if (!exampleId) {
                        // Show subtle notification instead of alert
                        const notification = document.createElement('div');
                        notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ff9800; color: white; padding: 12px 20px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10000;';
                        notification.textContent = 'Cannot find example ID. Please ensure an example is loaded.';
                        document.body.appendChild(notification);
                        setTimeout(() => notification.remove(), 3000);
                        return;
                    }
                    
                    try {
                        rejectBtn.disabled = true;
                        rejectBtn.textContent = 'Rejecting...';
                        
                        const resp = await fetch(`/v1/projects/${projectId}/tracking/${exampleId}/reject/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCsrfToken()
                            },
                            body: JSON.stringify({ review_notes: '' })
                        });
                        
                        const data = await resp.json();
                        
                        if (resp.ok) {
                            // Show subtle notification instead of alert
                            const notification = document.createElement('div');
                            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ff9800; color: white; padding: 12px 20px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10000;';
                            notification.textContent = '✅ Example rejected. Annotator will see it again for revision.';
                            document.body.appendChild(notification);
                            setTimeout(() => notification.remove(), 2000);
                            updateStatus();
                        } else {
                            // Show error notification instead of alert
                            const notification = document.createElement('div');
                            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #f44336; color: white; padding: 12px 20px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10000;';
                            notification.textContent = '❌ ' + (data.error || 'Unknown error');
                            document.body.appendChild(notification);
                            setTimeout(() => notification.remove(), 4000);
                        }
                    } catch (error) {
                        // Show error notification instead of alert
                        const notification = document.createElement('div');
                        notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #f44336; color: white; padding: 12px 20px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10000;';
                        notification.textContent = '❌ Network error: ' + error.message;
                        document.body.appendChild(notification);
                        setTimeout(() => notification.remove(), 4000);
                    } finally {
                        rejectBtn.disabled = false;
                        rejectBtn.textContent = '✗ Reject';
                    }
                };
                
                // Add buttons to container
                buttonsContainer.appendChild(statusDisplay);
                buttonsContainer.appendChild(approveBtn);
                buttonsContainer.appendChild(rejectBtn);
                
                // Add to page
                document.body.appendChild(buttonsContainer);
                
                console.log('[Monlam Approve] ✅ Buttons added');
                
                // Update status initially
                setTimeout(updateStatus, 1000);
                
                // Update status when navigating between examples
                let lastExampleId = getCurrentExampleId();
                setInterval(() => {
                    const currentExampleId = getCurrentExampleId();
                    if (currentExampleId && currentExampleId !== lastExampleId) {
                        lastExampleId = currentExampleId;
                        updateStatus();
                    }
                }, 1000);
            });
            
        } catch (error) {
            console.error('[Monlam Approve] Error:', error);
        }
    }
    }  // Close addApproveRejectButtons
    
    // ========================================
    // FEATURE: AUTO-FILTER + HIDE ANNOTATE BUTTONS FOR ANNOTATORS
    // Uses Doccano's native isChecked=false filter
    // Applies to BOTH dataset page AND annotation pages
    // ========================================
    let filterCheckInProgress = false;
    let lastFilterCheckPath = '';
    
    async function setDefaultFilterForAnnotators() {
        const path = window.location.pathname;
        
        // Prevent concurrent/duplicate runs
        if (filterCheckInProgress) {
            console.log('[Monlam Filter] ⏳ Already checking, skipping');
            return;
        }
        
        // Prevent running multiple times for same path
        const fullPath = path + window.location.search;
        if (lastFilterCheckPath === fullPath) {
            console.log('[Monlam Filter] ⏳ Already processed this path, skipping');
            return;
        }
        
        filterCheckInProgress = true;
        lastFilterCheckPath = fullPath;
        
        // Run on dataset page OR annotation pages
        const isDatasetPage = path.includes('/dataset');
        const isAnnotationPage = path.includes('/speech-to-text') || 
                                  path.includes('/sequence-labeling') ||
                                  path.includes('/document-classification') ||
                                  path.includes('/seq2seq') ||
                                  path.includes('/intent-detection-and-slot-filling') ||
                                  path.includes('/image-classification') ||
                                  path.includes('/bounding-box') ||
                                  path.includes('/segmentation') ||
                                  path.includes('/image-captioning');
        
        if (!isDatasetPage && !isAnnotationPage) return;
        
        try {
            const projectMatch = path.match(/\/projects\/(\d+)/);
            if (!projectMatch) return;
            const projectId = projectMatch[1];
            
            // Check user role
            const roleResp = await fetch(`/v1/projects/${projectId}/my-role`);
            if (!roleResp.ok) return;
            const roleData = await roleResp.json();
            const roleName = (roleData.rolename || roleData.role || '').toLowerCase();
            
            // DEBUG: Log the full role data
            console.log('[Monlam Filter] 📋 Role data from API:', JSON.stringify(roleData));
            console.log('[Monlam Filter] 📋 Role name detected:', roleName);
            
            const isAnnotator = roleName.includes('annotator') && 
                               !roleName.includes('admin') && 
                               !roleName.includes('manager') && 
                               !roleName.includes('approver');
            
            // Also check if we're privileged (manager, admin, approver)
            const isPrivileged = roleName.includes('admin') || 
                                roleName.includes('manager') || 
                                roleName.includes('approver');
            
            console.log('[Monlam Filter] 📋 isAnnotator:', isAnnotator, 'isPrivileged:', isPrivileged);
            
            if (isAnnotator) {
                console.log('[Monlam Filter] 🔍 User is annotator on', isDatasetPage ? 'dataset' : 'annotation', 'page');
                
                if (isAnnotationPage) {
                    // On annotation pages: Set filter to "Undone" (isChecked=false) for annotators
                    // This hides confirmed/finished examples (status='submitted', not approved)
                    // Note: Approved examples (status='approved') are hidden separately below
                    clickUndoneFilter();
                    // Also hide approved examples specifically (status='approved')
                    hideApprovedExamplesForAnnotators();
                    setInterval(() => {
                        hideApprovedExamplesForAnnotators();
                    }, 1000);
                } else if (isDatasetPage) {
                    // On dataset page: Show all examples (no filter), but hide "Annotate" buttons
                    // Also hide approved examples from annotators (status='approved')
                    hideAnnotateButtonsForAnnotators();
                    hideApprovedExamplesForAnnotators();
                    setInterval(() => {
                        hideAnnotateButtonsForAnnotators();
                        hideApprovedExamplesForAnnotators();
                    }, 1000);
                }
                
            } else {
                console.log('[Monlam Filter] ✨ User is privileged (' + roleName + '), showing all examples');
            }
        } catch (error) {
            console.error('[Monlam Filter] Error:', error);
        } finally {
            filterCheckInProgress = false;
        }
    }
    
    function clickUndoneFilter() {
        /**
         * Set Doccano's filter to "Undone" (isChecked=false) via Vue Router.
         * This shows only unconfirmed/unfinished examples.
         * 
         * IMPORTANT DISTINCTION:
         * - Confirmed/Finished/Submitted: Annotator completed their work (ExampleState exists, status='submitted')
         *   This filter hides these examples from annotators.
         * - Approved: Approver reviewed and approved (status='approved')
         *   Approved examples are hidden separately via hideApprovedExamplesForAnnotators()
         * 
         * Based on Doccano's ToolbarLaptop.vue:
         * - Filter stored in URL query param: isChecked
         * - Values: '' (All), 'true' (Done), 'false' (Undone)
         * - Changed via: $router.push({ query: { isChecked: 'false' } })
         */
        
        let attempts = 0;
        const maxAttempts = 15;
        
        const trySetFilter = () => {
            attempts++;
            
            // Check current filter value
            const currentIsChecked = new URLSearchParams(window.location.search).get('isChecked');
            
            // If already set to 'false', we're done
            if (currentIsChecked === 'false') {
                console.log('[Monlam Filter] ✅ Filter already set to Undone');
                return;
            }
            
            // Method 1: Use Vue Router (the official Doccano way)
            if (window.$nuxt && window.$nuxt.$router && window.$nuxt.$route) {
                try {
                    const currentQuery = window.$nuxt.$route.query || {};
                    
                    // Only set if not already 'false'
                    if (currentQuery.isChecked !== 'false') {
                        console.log('[Monlam Filter] 🔄 Setting isChecked=false via Vue Router');
                        
                        window.$nuxt.$router.push({
                            query: {
                                ...currentQuery,
                                page: currentQuery.page || '0',
                                isChecked: 'false',
                                q: currentQuery.q || ''
                            }
                        }).then(() => {
                            console.log('[Monlam Filter] ✅ Filter set to Undone via Vue Router');
                        }).catch((err) => {
                            // NavigationDuplicated is ok
                            if (err.name !== 'NavigationDuplicated') {
                                console.log('[Monlam Filter] Router error:', err.message);
                            }
                        });
                        
                        return;
                    }
                } catch (e) {
                    console.log('[Monlam Filter] Vue Router method failed:', e.message);
                }
            }
            
            // Retry if Vue not ready yet
            if (attempts < maxAttempts) {
                setTimeout(trySetFilter, 500);
            } else {
                console.log('[Monlam Filter] ⚠️ Could not set filter after', maxAttempts, 'attempts');
                
                // Last resort: Direct URL change with page reload
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('isChecked') !== 'false') {
                    urlParams.set('isChecked', 'false');
                    urlParams.set('page', urlParams.get('page') || '0');
                    const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
                    console.log('[Monlam Filter] Last resort: redirecting to', newUrl);
                    window.location.href = newUrl;
                }
            }
        };
        
        // Start after Vue has had time to initialize
        setTimeout(trySetFilter, 800);
    }
    
    function hideAnnotateButtonsForAnnotators() {
        /**
         * Hide "Annotate" buttons on dataset table rows for annotators.
         * They should use "Start Annotation" button which has proper filtering and locking.
         */
        
        // Find all annotate links/buttons in the table (not the main "Start Annotation" button)
        const table = document.querySelector('table');
        if (!table) return;
        
        const annotateLinks = table.querySelectorAll('a[href*="speech-to-text"], a[href*="sequence-labeling"], a[href*="document-classification"], a[href*="seq2seq"]');
        
        annotateLinks.forEach(link => {
            if (!link.dataset.monlamHidden) {
                link.style.display = 'none';
                link.dataset.monlamHidden = 'true';
                console.log('[Monlam Filter] Hidden annotate button in row');
            }
        });
        
        // Also hide any buttons that might be "Annotate" actions
        const actionCells = table.querySelectorAll('td');
        actionCells.forEach(cell => {
            const buttons = cell.querySelectorAll('button, .v-btn');
            buttons.forEach(btn => {
                const text = btn.textContent?.toLowerCase() || '';
                if (text.includes('annotate') && !btn.dataset.monlamHidden) {
                    btn.style.display = 'none';
                    btn.dataset.monlamHidden = 'true';
                }
            });
        });
    }
    
    function hideApprovedExamplesForAnnotators() {
        /**
         * Hide approved examples from annotators.
         * 
         * IMPORTANT: This is different from hiding confirmed/finished examples.
         * - Confirmed/Finished/Submitted: Annotator completed their work (status='submitted')
         * - Approved: Approver reviewed and approved (status='approved')
         * - Rejected: Approver rejected (status='rejected') - SHOULD BE VISIBLE to annotator
         * 
         * Annotators should NOT see approved examples, but they CAN see:
         * - Their own submitted examples (to check status)
         * - Rejected examples (to fix and resubmit)
         */
        
        const table = document.querySelector('table');
        if (!table) return;
        
        // Get all table rows
        const rows = table.querySelectorAll('tbody tr, tr[data-example-id]');
        
        rows.forEach(row => {
            // Check if row has status indicator or assignment data
            const statusCell = row.querySelector('[data-status], .status, .v-chip');
            const statusText = statusCell ? statusCell.textContent.toLowerCase() : '';
            
            // Check for rejected status - DO NOT HIDE rejected examples
            const isRejected = statusText.includes('rejected') || 
                              statusText.includes('❌ rejected') ||
                              row.dataset.status === 'rejected';
            
            // If rejected, make sure it's visible (annotator needs to fix it)
            if (isRejected) {
                if (row.dataset.monlamApprovedHidden) {
                    row.style.display = '';
                    delete row.dataset.monlamApprovedHidden;
                    console.log('[Monlam Filter] Showing rejected example row (annotator needs to fix)');
                }
                return; // Don't hide rejected examples
            }
            
            // Check for approved status indicators
            const isApproved = statusText.includes('approved') && !statusText.includes('rejected') ||
                              statusText.includes('✅ approved') ||
                              (row.querySelector('[style*="green"], [class*="approved"]') && !isRejected) ||
                              row.dataset.status === 'approved';
            
            // Also check if row has a data attribute indicating approval
            if (isApproved || row.dataset.approved === 'true') {
                if (!row.dataset.monlamApprovedHidden) {
                    row.style.display = 'none';
                    row.dataset.monlamApprovedHidden = 'true';
                    console.log('[Monlam Filter] Hidden approved example row');
                }
            } else {
                // Make sure we show non-approved rows (including rejected)
                if (row.dataset.monlamApprovedHidden) {
                    row.style.display = '';
                    delete row.dataset.monlamApprovedHidden;
                }
            }
        });
        
        // Also check Vue component data if available (for enhanced dataset view)
        if (window.$nuxt && window.$nuxt.$root) {
            try {
                // Try to access Vue component instances that might have example data
                const vueInstances = document.querySelectorAll('[data-v-]');
                vueInstances.forEach(instance => {
                    // This is a fallback - the main filtering should happen via API
                });
            } catch (e) {
                // Vue might not be ready, that's okay
            }
        }
    }
    
    // ========================================
    // NOTE: Example locking removed - single annotator per project, no race conditions
    // ========================================
    
    // METRICS PAGE REDIRECT - Vue Router Aware (Professional Implementation)
    function setupMetricsRedirect() {
        console.log('[Monlam Metrics] Setting up redirect interception...');
        
        // Check if we're already ON the metrics page (immediate redirect)
        function checkAndRedirect() {
            const path = window.location.pathname;
            const match = path.match(/^\/projects\/(\d+)\/metrics/);
            
            if (match) {
                const projectId = match[1];
                const redirectUrl = `/monlam/${projectId}/completion/`;
                console.log('[Monlam Metrics] ⚡ On metrics page, redirecting to:', redirectUrl);
                window.location.replace(redirectUrl);
                return true;
            }
            return false;
        }
        
        // Try immediate redirect if on metrics page
        if (checkAndRedirect()) {
            return; // Stop further execution
        }
        
        // ========================================
        // Method 1: Intercept clicks (capture phase)
        // ========================================
        document.addEventListener('click', function(e) {
            const link = e.target.closest('a');
            if (!link) return;
            
            const href = link.getAttribute('href') || link.href;
            if (!href) return;
            
            // Check if it's a metrics link
            const match = href.match(/\/projects\/(\d+)\/metrics/);
            if (match) {
                const projectId = match[1];
                
                // Prevent default behavior
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                // Redirect
                const redirectUrl = `/monlam/${projectId}/completion/`;
                console.log('[Monlam Metrics] ⚡ Click intercepted, redirecting to:', redirectUrl);
                window.location.replace(redirectUrl);
                
                return false;
            }
        }, true); // Capture phase = runs BEFORE Vue Router
        
        // ========================================
        // Method 2: Monitor and override metrics links
        // ========================================
        function overrideMetricsLinks() {
            document.querySelectorAll('a[href*="/metrics"]').forEach(link => {
                const href = link.getAttribute('href') || link.href;
                const match = href.match(/\/projects\/(\d+)\/metrics/);
                
                if (match && !link.hasAttribute('data-monlam-metrics-override')) {
                    const projectId = match[1];
                    link.setAttribute('data-monlam-metrics-override', 'true');
                    
                    // Override onclick
                    link.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        
                        const redirectUrl = `/monlam/${projectId}/completion/`;
                        console.log('[Monlam Metrics] ⚡ Direct click, redirecting to:', redirectUrl);
                        window.location.replace(redirectUrl);
                        
                        return false;
                    };
                    
                    console.log('[Monlam Metrics] ✅ Overrode metrics link for project', projectId);
                }
            });
        }
        
        // Run initially and periodically
        overrideMetricsLinks();
        setInterval(overrideMetricsLinks, 500);
        
        // ========================================
        // Method 3: Intercept Vue Router (when available)
        // ========================================
        function interceptVueRouter() {
            // Wait for $nuxt to be available
            if (!window.$nuxt || !window.$nuxt.$router) {
                return;
            }
            
            // Only intercept once
            if (window.$nuxt.$router._monlamMetricsIntercepted) {
                return;
            }
            
            const router = window.$nuxt.$router;
            
            // Intercept push
            const originalPush = router.push;
            router.push = function(location) {
                // Handle both string and object location
                let path = typeof location === 'string' ? location : location.path;
                
                if (path && path.includes('/metrics')) {
                    const match = path.match(/\/projects\/(\d+)\/metrics/);
                    if (match) {
                        const projectId = match[1];
                        const redirectUrl = `/monlam/${projectId}/completion/`;
                        console.log('[Monlam Metrics] ⚡ Intercepted Router.push, redirecting to:', redirectUrl);
                        window.location.replace(redirectUrl);
                        return Promise.resolve(); // Return resolved promise to avoid errors
                    }
                }
                
                return originalPush.call(this, location);
            };
            
            // Intercept replace
            const originalReplace = router.replace;
            router.replace = function(location) {
                let path = typeof location === 'string' ? location : location.path;
                
                if (path && path.includes('/metrics')) {
                    const match = path.match(/\/projects\/(\d+)\/metrics/);
                    if (match) {
                        const projectId = match[1];
                        const redirectUrl = `/monlam/${projectId}/completion/`;
                        console.log('[Monlam Metrics] ⚡ Intercepted Router.replace, redirecting to:', redirectUrl);
                        window.location.replace(redirectUrl);
                        return Promise.resolve();
                    }
                }
                
                return originalReplace.call(this, location);
            };
            
            router._monlamMetricsIntercepted = true;
            console.log('[Monlam Metrics] ✅ Vue Router intercepted');
        }
        
        // Try to intercept router immediately
        interceptVueRouter();
        
        // Keep trying until router is available
        let attempts = 0;
        const maxAttempts = 20;
        const routerCheckInterval = setInterval(() => {
            attempts++;
            interceptVueRouter();
            
            if (window.$nuxt?.$router?._monlamMetricsIntercepted || attempts >= maxAttempts) {
                clearInterval(routerCheckInterval);
            }
        }, 500);
        
        console.log('[Monlam Metrics] ✅ Redirect system initialized');
    }
    
    // Removed: autoAnnotateExample() and autoStartAnnotation()
    // No longer needed since we enhance the original dataset table
    // Users just click Doccano's original Annotate button
    
    // FEATURE: ENHANCE DATASET TABLE WITH TRACKING COLUMNS (Vue-Aware)
    async function enhanceDatasetTable() {
        // Check if we're on dataset page
        if (!window.location.pathname.includes('/dataset')) {
            return;
        }
        
        const projectId = getProjectId();
        if (!projectId) {
            console.log('[Monlam Dataset] No project ID found');
            return;
        }
        
        // Check if table ACTUALLY has our columns (not just a flag)
        // Vue re-renders destroy the DOM, so we must check the actual table
        const existingHeaders = document.querySelector('.monlam-status-header');
        if (existingHeaders) {
            console.log('[Monlam Dataset] Table already has enhancement headers, skipping');
            return;
        }
        
        console.log('[Monlam Dataset] ✨ Starting table enhancement for project', projectId);
        
        try {
            // Fetch examples with embedded tracking data from SERIALIZER
            // The serializer adds: annotated_by_username, reviewed_by_username, tracking_status
            const examplesResp = await fetch(`/v1/projects/${projectId}/examples?limit=1000`);
            if (!examplesResp.ok) {
                console.error('[Monlam Dataset] Failed to fetch examples:', examplesResp.status);
                return;
            }
            
            const examplesData = await examplesResp.json();
            
            // Build a map of example_id -> tracking data
            // IMPORTANT: Use CORRECT field names from serializer
            const trackingMap = {};
            (examplesData.results || []).forEach(ex => {
                trackingMap[ex.id] = {
                    annotated_by: ex.annotated_by_username || null,  // ← Correct field name
                    reviewed_by: ex.reviewed_by_username || null,    // ← Correct field name
                    status: ex.tracking_status || 'pending'           // ← Correct field name
                };
            });
            
            console.log('[Monlam Dataset] ✅ Loaded', Object.keys(trackingMap).length, 'tracking records');
            
            // Function to enhance table (runs ONCE with Vue reactivity awareness)
            function enhanceTable() {
                const headerRow = document.querySelector('thead tr');
                if (!headerRow) {
                    console.log('[Monlam Dataset] No header row found yet');
                    return false;
                }
                
                // Check if ALREADY enhanced (global check)
                if (headerRow.querySelector('.monlam-status-header')) {
                    console.log('[Monlam Dataset] Table already has headers');
                    return true; // Already done
                }
                
                const headers = Array.from(headerRow.querySelectorAll('th'));
                if (headers.length < 3) {
                    console.log('[Monlam Dataset] Not enough columns yet:', headers.length);
                    return false;
                }
                
                // Create status header
                const statusHeader = document.createElement('th');
                statusHeader.textContent = 'Status';
                statusHeader.className = 'monlam-status-header monlam-status-col-header';
                statusHeader.style.cssText = 'padding: 8px; text-align: left; font-weight: 600; border-bottom: 1px solid #e0e0e0; white-space: nowrap;';
                
                // Append status column to the end (don't move it - let it stay in natural position)
                headerRow.appendChild(statusHeader);
                console.log('[Monlam Dataset] ✅ Status header appended to end');
                
                // Add data cells to rows
                enhanceDataRows(trackingMap);
                
                // Set up MutationObserver immediately to watch for new rows (e.g., pagination)
                const tbody = document.querySelector('tbody');
                if (tbody && !window.monlamTbodyObserver) {
                    window.monlamTbodyObserver = new MutationObserver(() => {
                        const newRows = document.querySelectorAll('tbody tr:not([data-monlam-enhanced])');
                        if (newRows.length > 0) {
                            enhanceDataRows(trackingMap); // Process new rows only
                        }
                    });
                    window.monlamTbodyObserver.observe(tbody, { childList: true, subtree: true });
                }
                
                return true;
            }
            
            function enhanceDataRows(trackingMap) {
                const dataRows = document.querySelectorAll('tbody tr:not([data-monlam-enhanced])');
                if (dataRows.length === 0) return;
                
                // Status badge colors (moved outside loop for better performance)
                const statusColors = {
                    'pending': '#e0e0e0',
                    'in_progress': '#2196f3',
                    'submitted': '#ff9800',
                    'approved': '#4caf50',
                    'rejected': '#f44336'
                };
                
                // Process rows efficiently
                dataRows.forEach(row => {
                    // Mark as processed IMMEDIATELY
                    row.setAttribute('data-monlam-enhanced', 'true');
                    
                    // Extract example ID from first cell
                    const cells = row.querySelectorAll('td');
                    if (cells.length < 3) return;
                    
                    // First cell typically contains checkbox/ID
                    const idMatch = cells[1]?.textContent.match(/(\d+)/) || cells[0]?.textContent.match(/(\d+)/);
                    if (!idMatch) return;
                    
                    const exampleId = parseInt(idMatch[1]);
                    const tracking = trackingMap[exampleId];
                    const status = tracking?.status || 'pending';
                    
                    const color = statusColors[status] || '#e0e0e0';
                    const textColor = (status === 'pending') ? '#666' : 'white';
                    
                    // Create status cell
                    const statusCell = document.createElement('td');
                    statusCell.className = 'monlam-status-cell';
                    statusCell.style.cssText = 'padding: 8px; border-bottom: 1px solid #e0e0e0; white-space: nowrap;';
                    statusCell.innerHTML = `<span style="background: ${color}; color: ${textColor}; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">${status.replace('_', ' ').toUpperCase()}</span>`;
                    
                    // Append status cell to the end (don't move it - let it stay in natural position)
                    row.appendChild(statusCell);
                });
                
                return true;
            }
            
            // Try to enhance once Vue has rendered the table
            // Use exponential backoff to avoid hammering the DOM
            let attempt = 0;
            const maxAttempts = 5;
            const baseDelay = 100; // Reduced from 500ms for faster initial load
            
            function tryEnhance() {
                attempt++;
                const success = enhanceTable();
                
                if (success) {
                    console.log('[Monlam Dataset] ✅ Enhancement complete after', attempt, 'attempts');
                } else if (attempt < maxAttempts) {
                    const delay = baseDelay * Math.pow(1.5, attempt);
                    setTimeout(tryEnhance, delay);
                }
            }
            
            // Start enhancement immediately (reduced delay for faster loading)
            setTimeout(tryEnhance, 100);
            
        } catch (error) {
            console.error('[Monlam Dataset] ❌ Error enhancing table:', error);
        }
    }
    
    // ========================================
    // FEATURE: Add "Change Password" to User Menu
    // ========================================
    function addChangePasswordLink() {
        // Watch for the user dropdown menu to appear
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) {
                        // Look for the v-list that contains sign out
                        const signOutItems = node.querySelectorAll ? 
                            node.querySelectorAll('.v-list-item') : [];
                        
                        signOutItems.forEach((item) => {
                            const title = item.querySelector('.v-list-item__title');
                            if (title && (title.textContent.includes('Sign Out') || 
                                         title.textContent.includes('ཕྱིར་འཐོན།') ||
                                         title.textContent.includes('Ausloggen') ||
                                         title.textContent.includes('Déconnexion') ||
                                         title.textContent.includes('注销'))) {
                                
                                // Check if we already added the link
                                const parent = item.parentElement;
                                if (parent && !parent.querySelector('.monlam-change-password')) {
                                    // Create Change Password item
                                    const changePasswordItem = document.createElement('div');
                                    changePasswordItem.className = 'v-list-item v-list-item--link theme--light monlam-change-password';
                                    changePasswordItem.style.cursor = 'pointer';
                                    changePasswordItem.innerHTML = `
                                        <div class="v-list-item__icon">
                                            <i class="v-icon mdi mdi-lock-reset theme--light"></i>
                                        </div>
                                        <div class="v-list-item__content">
                                            <div class="v-list-item__title">གསང་ཨང་བསྒྱུར་བ། (Change Password)</div>
                                        </div>
                                    `;
                                    changePasswordItem.onclick = () => {
                                        window.location.href = '/monlam/change-password/';
                                    };
                                    
                                    // Insert before Sign Out
                                    parent.insertBefore(changePasswordItem, item);
                                }
                            }
                        });
                    }
                });
            });
        });
        
        observer.observe(document.body, { childList: true, subtree: true });
    }
    
    // ========================================
    // FEATURE: Custom Project Home Page (Graceful)
    // ========================================
    let projectHomeCustomized = false;
    
    function customizeProjectHomePage() {
        try {
            const path = window.location.pathname;
            
            // Check if on project home page (pattern: /projects/{id}/ or /projects/{id})
            const projectHomeMatch = path.match(/^\/projects\/(\d+)\/?$/);
            if (!projectHomeMatch) {
                projectHomeCustomized = false; // Reset flag when leaving page
                return;
            }
            
            // Already customized this page
            if (projectHomeCustomized && document.getElementById('monlam-home-content')) {
                return;
            }
            
            const projectId = projectHomeMatch[1];
            
            // Wait for the stepper (YouTube video container) to appear
            const checkAndReplace = () => {
                // Don't run if already customized
                if (document.getElementById('monlam-home-content')) {
                    return true;
                }
                
                const stepper = document.querySelector('.v-stepper');
                
                if (stepper) {
                    console.log('[Monlam Home] Customizing project home page');
                    
                    // Find the card containing the stepper (NOT the entire main content)
                    const cardToReplace = stepper.closest('.v-card');
                    
                    if (cardToReplace) {
                        // Mark as customized
                        projectHomeCustomized = true;
                        
                        // Replace only the card content (not the sidebar)
                        cardToReplace.innerHTML = `
                            <div id="monlam-home-content" style="padding: 24px; font-family: MonlamTBslim, 'Noto Sans Tibetan', Roboto, sans-serif;">
                        <div style="padding: 24px; font-family: MonlamTBslim, 'Noto Sans Tibetan', Roboto, sans-serif;">
                            
                            <!-- Welcome Header -->
                            <div style="background: linear-gradient(135deg, #1976d2, #42a5f5); color: white; padding: 32px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                <h1 style="margin: 0; font-size: 2rem;">
                                    👋 བཀྲ་ཤིས་བདེ་ལེགས། Welcome!
                                </h1>
                            </div>
                            
                            <!-- Quick Actions -->
                            <div style="background: white; padding: 24px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h2 style="margin-top: 0; color: #333;">
                                    ⚡ མྱུར་སྤྱོད་བྱེད་སྒོ། / Quick Actions
                                </h2>
                                <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                                    <button id="monlam-start-btn"
                                            style="background: #1976d2; color: white; border: none; padding: 16px 32px; border-radius: 8px; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                        ▶️ མཆན་འགྲེལ་འགོ་འཛུགས། / Start Annotation
                                    </button>
                                    <button id="monlam-dataset-btn"
                                            style="background: white; color: #1976d2; border: 2px solid #1976d2; padding: 16px 32px; border-radius: 8px; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                        📊 གཞི་གྲངས། / Dataset
                                    </button>
                                    <button id="monlam-stats-btn"
                                            style="background: white; color: #666; border: 2px solid #666; padding: 16px 32px; border-radius: 8px; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                        📈 གྲུབ་ཐོ། / Statistics
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Instructions Grid -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">
                                
                                <!-- Annotator Instructions -->
                                <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #2196f3;">
                                    <h2 style="margin-top: 0; color: #1565c0;">
                                        ✏️ ལས་མིའི་ལམ་སྟོན། / Annotator Instructions
                                    </h2>
                                    <h3 style="color: #1976d2; margin-bottom: 16px;">
                                        མཆན་འགྲེལ་ཇི་ལྟར་རྒྱག་དགོས་མིན། / How to Annotate
                                    </h3>
                                    
                                    <div style="border-left: 2px solid #2196f3; padding-left: 16px; margin-bottom: 16px;">
                                        <p style="margin: 8px 0;">
                                            <strong style="color: #1976d2;">གོམ་པ་དང་པོ། / Step 1:</strong><br>
                                            'མཆན་འགྲེལ་འགོ་འཛུགས་'ཞེས་པར་གནོན་ནས་འགོ་འཛུགས་བྱེད་དགོས།<br>
                                            <span style="color: #666;">Click 'Start Annotation' to begin</span>
                                        </p>
                                    </div>
                                    
                                    <div style="border-left: 2px solid #2196f3; padding-left: 16px; margin-bottom: 16px;">
                                        <p style="margin: 8px 0;">
                                            <strong style="color: #1976d2;">གོམ་པ་གཉིས་པ། / Step 2:</strong><br>
                                            སྒྲ་ལ་ཉན་ནས་ཡིག་ཐོག་གི་འབྲི་རྩོམ་ལ་ཞིབ་བཤེར་བྱེད་དགོས།<br>
                                            <span style="color: #666;">Listen to the audio and check the transcription</span>
                                        </p>
                                    </div>
                                    
                                    <div style="border-left: 2px solid #2196f3; padding-left: 16px; margin-bottom: 16px;">
                                        <p style="margin: 8px 0;">
                                            <strong style="color: #1976d2;">གོམ་པ་གསུམ་པ། / Step 3:</strong><br>
                                            དགོས་ངེས་ཡིན་ན་ཡིག་རྩོམ་ལ་བཟོ་བཅོས་རྒྱག་པ།<br>
                                            <span style="color: #666;">Edit the text if needed</span>
                                        </p>
                                    </div>
                                    
                                    <div style="border-left: 2px solid #4caf50; padding-left: 16px;">
                                        <p style="margin: 8px 0;">
                                            <strong style="color: #388e3c;">གོམ་པ་བཞི་པ། / Step 4:</strong><br>
                                            ར་སྤྲོད་བྱེད་པའི་ཆེད་དུ་རྟགས་ (✓) ལ་གནོན་ནས་མདུན་དུ་འགྲོ་དགོས།<br>
                                            <span style="color: #666;">Click the checkmark (✓) to confirm and move to next</span>
                                        </p>
                                    </div>
                                </div>
                                
                                <!-- Reviewer Instructions -->
                                <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #ff9800;">
                                    <h2 style="margin-top: 0; color: #e65100;">
                                        ✅ ཚན་པའི་འགན་འཛིན་གྱི་ལམ་སྟོན། / Reviewer Instructions
                                    </h2>
                                    <h3 style="color: #f57c00; margin-bottom: 16px;">
                                        ཞིབ་བཤེར་ཇི་ལྟར་བྱེད་དགོས་མིན། / How to Review
                                    </h3>
                                    
                                    <div style="border-left: 2px solid #ff9800; padding-left: 16px; margin-bottom: 16px;">
                                        <p style="margin: 8px 0;">
                                            <strong style="color: #f57c00;">གོམ་པ་དང་པོ། / Step 1:</strong><br>
                                            གཞི་གྲངས་ཚོགས་ལ་འགྲོ་ནས་ 'གྲུབ་ཟིན་པ་'ཞེས་པར་ལ་གཟིགས་དགོས།<br>
                                            <span style="color: #666;">Go to Dataset and filter by 'Done'</span>
                                        </p>
                                    </div>
                                    
                                    <div style="border-left: 2px solid #ff9800; padding-left: 16px; margin-bottom: 16px;">
                                        <p style="margin: 8px 0;">
                                            <strong style="color: #f57c00;">གོམ་པ་གཉིས་པ། / Step 2:</strong><br>
                                            མཆན་འགྲེལ་རེ་རེ་བཞིན་དག་ཚད་ལ་ཞིབ་བཤེར་བྱེད་པ།<br>
                                            <span style="color: #666;">Check each annotation for accuracy</span>
                                        </p>
                                    </div>
                                    
                                    <div style="border-left: 2px solid #4caf50; padding-left: 16px;">
                                        <p style="margin: 8px 0;">
                                            <strong style="color: #388e3c;">གོམ་པ་གསུམ་པ། / Step 3:</strong><br>
                                            'འགྲིག' ཡང་ན་ 'མ་འགྲིག' ཞེས་པར་འོས་འཚམ་ལྟར་གནོན་དགོས།<br>
                                            <span style="color: #666;">Click 'Approve' or 'Reject' as appropriate</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Footer Note -->
                            <div style="background: #f5f5f5; padding: 16px; border-radius: 8px; margin-top: 24px; text-align: center;">
                                <p style="margin: 0; color: #666;">
                                    ❓ རོགས་རམ་དགོས་སམ། ཁྱེད་ཀྱི་ཚན་པའི་འགན་འཛིན་ཡང་ན་དམིགས་འབེན་འགན་འཛིན་ལ་འབྲེལ་བ་གནང་རོགས།<br>
                                    <span style="color: #999;">Need help? Contact your project administrator.</span>
                                </p>
                            </div>
                        </div>
                    `;
                    
                    // Attach click handlers to our custom buttons
                    setTimeout(() => {
                        // Start Annotation button - click the sidebar button
                        const startBtn = document.getElementById('monlam-start-btn');
                        if (startBtn) {
                            startBtn.onclick = () => {
                                // Find and click the sidebar "Start Annotation" button
                                const sidebarStartBtn = document.querySelector('.v-navigation-drawer .v-btn.primary, .v-list .v-btn.primary');
                                if (sidebarStartBtn) {
                                    sidebarStartBtn.click();
                                } else {
                                    // Fallback: navigate directly
                                    window.location.href = '/projects/' + projectId + '/speech-to-text';
                                }
                            };
                        }
                        
                        // Dataset button - click the sidebar item
                        const datasetBtn = document.getElementById('monlam-dataset-btn');
                        if (datasetBtn) {
                            datasetBtn.onclick = () => {
                                // Find and click the sidebar "Dataset" item
                                const sidebarItems = document.querySelectorAll('.v-list-item');
                                for (const item of sidebarItems) {
                                    const title = item.querySelector('.v-list-item__title');
                                    if (title && (title.textContent.includes('གཞི་གྲངས') || title.textContent.includes('Dataset'))) {
                                        item.click();
                                        return;
                                    }
                                }
                                // Fallback
                                window.location.href = '/projects/' + projectId + '/dataset';
                            };
                        }
                        
                        // Statistics button
                        const statsBtn = document.getElementById('monlam-stats-btn');
                        if (statsBtn) {
                            statsBtn.onclick = () => {
                                window.location.href = '/monlam/' + projectId + '/completion/';
                            };
                        }
                    }, 100);
                    
                    return true;
                }
            }
            return false;
        };
        
            // Try immediately and then with limited retries
            if (!checkAndReplace()) {
                let attempts = 0;
                const interval = setInterval(() => {
                    if (checkAndReplace() || attempts++ > 10) {
                        clearInterval(interval);
                    }
                }, 300);
            }
        } catch (e) {
            console.error('[Monlam Home] Error customizing home page:', e);
        }
    }
    
    function init() {
        console.log('[Monlam] 🚀 Initializing features...');
        console.log('[Monlam] Current path:', window.location.pathname);
        
        // Customize project home page (replace YouTube videos with instructions)
        customizeProjectHomePage();
        
        // Set up metrics redirect IMMEDIATELY (before Vue Router)
        setupMetricsRedirect();
        
        // Add "Change Password" link to user dropdown
        addChangePasswordLink();
        
        // Set default filter for annotators FIRST (before other features)
        setDefaultFilterForAnnotators();
        
        // Initialize features after a short delay (let Vue render)
        setTimeout(() => {
            enableAudioLoop();  // Only loops on annotation pages (not dataset)
            enhanceDatasetTable();
            addApproveRejectButtons();
            // REMOVED: handleExampleLocking() - No longer needed with single annotator per project
        }, 1000);
        
        // Monitor SPA navigation and re-initialize on route change
        let lastPath = window.location.pathname;
        setInterval(() => {
            const currentPath = window.location.pathname;
            
            if (currentPath !== lastPath) {
                lastPath = currentPath;
                console.log('[Monlam] 🔄 Navigation detected:', currentPath);
                
                // Reset page-specific flags (but not global ones)
                // The enhance functions will check their own page-specific flags
                
                // Customize project home page if navigating there
                customizeProjectHomePage();
                
                // Set default filter for annotators on dataset navigation
                setDefaultFilterForAnnotators();
                
                setTimeout(() => {
                    enableAudioLoop();  // Only loops on annotation pages (not dataset)
                    enhanceDatasetTable();
                    addApproveRejectButtons();
                    // REMOVED: handleExampleLocking() - No longer needed with single annotator per project
                }, 500);
            }
        }, 500);
        
        console.log('[Monlam] ✅ Initialization complete');
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    console.log('[Monlam Inline] Features script loaded');
})();

    // ========================================
    // DIAGNOSTIC: Blank Page Detection for Annotation Pages
    // ========================================
    (function() {
        'use strict';
        
        // Only run on annotation pages
        const path = window.location.pathname;
        const isAnnotationPage = path.includes('/speech-to-text') || 
                                path.includes('/sequence-labeling') ||
                                path.includes('/document-classification') ||
                                path.includes('/seq2seq');
        
        if (!isAnnotationPage) return;
        
        const projectMatch = path.match(/\/projects\/(\d+)/);
        if (!projectMatch) return;
        const projectId = projectMatch[1];
        
        // Track if page has loaded content
        let pageHasContent = false;
        let diagnosticInfo = {
            url: window.location.href,
            projectId: projectId,
            userAgent: navigator.userAgent,
            timestamp: new Date().toISOString(),
            errors: []
        };
        
        // Check for content after 3 seconds
        setTimeout(() => {
            // Check if page has meaningful content
            const hasVueContent = document.querySelector('[data-nuxt]') || 
                                 document.querySelector('.v-application') ||
                                 document.querySelector('#app');
            const hasExampleContent = document.querySelector('audio') ||
                                     document.querySelector('.example') ||
                                     document.querySelector('[class*="example"]');
            const hasLoadingIndicator = document.querySelector('.v-progress-linear') ||
                                       document.querySelector('[class*="loading"]');
            
            // Check for JavaScript errors
            const originalError = window.onerror;
            window.onerror = function(msg, url, line, col, error) {
                diagnosticInfo.errors.push({
            type: 'JavaScript Error',
            message: msg,
            file: url,
            line: line,
            column: col
        });
                if (originalError) originalError.apply(this, arguments);
            };
            
            // Check if page appears blank
            const bodyText = document.body ? document.body.innerText.trim() : '';
            const hasMinimalContent = bodyText.length > 100 || hasVueContent || hasExampleContent || hasLoadingIndicator;
            
            if (!hasMinimalContent) {
                console.error('[Monlam Diagnostic] ⚠️ BLANK PAGE DETECTED');
                console.error('[Monlam Diagnostic] Project ID:', projectId);
                console.error('[Monlam Diagnostic] URL:', window.location.href);
                console.error('[Monlam Diagnostic] User Agent:', navigator.userAgent);
                
                // Show helpful error message
                const errorDiv = document.createElement('div');
                errorDiv.id = 'monlam-blank-page-error';
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.9);
                    color: white;
                    z-index: 99999;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    padding: 40px;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                    text-align: center;
                `;
                
                errorDiv.innerHTML = `
                    <div style="max-width: 600px;">
                        <h1 style="color: #ff6b6b; margin-bottom: 20px; font-size: 24px;">
                            ⚠️ Blank Page Detected
                        </h1>
                        <p style="margin-bottom: 30px; line-height: 1.6; font-size: 16px;">
                            The annotation page appears to be blank. This is usually caused by browser cache issues.
                        </p>
                        <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; margin-bottom: 30px; text-align: left;">
                            <h3 style="margin-top: 0; margin-bottom: 15px;">Try these steps:</h3>
                            <ol style="line-height: 2; padding-left: 20px;">
                                <li><strong>Hard Refresh:</strong> Press <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">Ctrl+Shift+R</code> (Windows/Linux) or <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">Cmd+Shift+R</code> (Mac)</li>
                                <li><strong>Clear Cache:</strong> Go to browser settings → Clear browsing data → Cached images and files</li>
                                <li><strong>Disable Extensions:</strong> Try in incognito/private mode to rule out browser extensions</li>
                                <li><strong>Check Console:</strong> Press F12 → Console tab → Look for red error messages</li>
                            </ol>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="window.location.reload(true)" style="background: #1976d2; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px;">
                                🔄 Reload Page
                            </button>
                            <button onclick="document.getElementById('monlam-blank-page-error').remove()" style="background: #666; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px;">
                                ✕ Dismiss
                            </button>
                        </div>
                        <p style="margin-top: 30px; font-size: 12px; color: #999;">
                            If this persists, contact support with this info:<br>
                            Project: ${projectId} | URL: ${window.location.href}
                        </p>
                    </div>
                `;
                
                document.body.appendChild(errorDiv);
                
                // Log diagnostic info
                console.error('[Monlam Diagnostic] Full diagnostic info:', diagnosticInfo);
                
                // Try to fetch examples to see if API is working
                fetch(`/v1/projects/${projectId}/examples?limit=1`)
                    .then(res => res.json())
                    .then(data => {
                        console.log('[Monlam Diagnostic] API Response:', data);
                        if (data.results && data.results.length === 0) {
                            console.error('[Monlam Diagnostic] ⚠️ No examples available for this project');
                        }
                    })
                    .catch(err => {
                        console.error('[Monlam Diagnostic] ❌ API Error:', err);
                        diagnosticInfo.errors.push({
                            type: 'API Error',
                            message: err.message
                        });
                    });
            } else {
                console.log('[Monlam Diagnostic] ✅ Page appears to have content');
            }
        }, 3000);
        
        // Also check for console errors
        const originalConsoleError = console.error;
        console.error = function(...args) {
            diagnosticInfo.errors.push({
                type: 'Console Error',
                message: args.join(' ')
            });
            originalConsoleError.apply(console, args);
        };
    })();
  </script>
</body>
</html>