# Render Blueprint for Monlam Doccano
# https://render.com/docs/blueprint-spec

services:
  # ===========================================
  # Main Doccano Web Service
  # ===========================================
  - type: web
    name: monlam-doccano
    env: docker
    plan: standard
    region: singapore
    healthCheckPath: /
    # Custom Docker command - bypass Doccano's problematic run.sh
    dockerCommand: >
      sh -c "
      cd /doccano/backend &&
      python manage.py migrate --noinput &&
      python manage.py create_admin --username=${ADMIN_USERNAME} --password=${ADMIN_PASSWORD} --email=${ADMIN_EMAIL} --noinput || true &&
      celery --app=config worker --loglevel=INFO --concurrency=1 --pool=solo &
      gunicorn --bind=0.0.0.0:${PORT} --workers=${WEB_CONCURRENCY} config.wsgi:application
      "
    envVars:
      - key: PORT
        value: "10000"
      - key: ADMIN_USERNAME
        value: admin
      - key: ADMIN_EMAIL
        value: admin@monlam.ai
      - key: ADMIN_PASSWORD
        sync: false
      - key: DATABASE_URL
        fromDatabase:
          name: doccano-db
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          name: doccano-rabbitmq
          type: pserv
          envVarKey: RABBITMQ_URL
      - key: DJANGO_SETTINGS_MODULE
        value: config.settings.production
      - key: DEBUG
        value: "False"
      - key: ALLOW_SIGNUP
        value: "False"
      - key: SECRET_KEY
        generateValue: true

  # ===========================================
  # RabbitMQ Message Broker (Private Service)
  # ===========================================
  - type: pserv
    name: doccano-rabbitmq
    runtime: image
    image:
      url: docker.io/library/rabbitmq:3-alpine
    plan: starter
    region: singapore
    envVars:
      - key: RABBITMQ_URL
        value: "amqp://guest:guest@doccano-rabbitmq:5672"

# ===========================================
# PostgreSQL Database
# ===========================================
databases:
  - name: doccano-db
    plan: basic-1gb
    region: singapore
    databaseName: doccano
    user: doccano
    postgresMajorVersion: "16"
    diskSizeGB: 10
