# ‚úÖ Final Deployment Configuration - Ready for Production

**Last Updated:** 2026-01-07  
**Status:** üü¢ Production Ready  
**Commit:** `90f2739` and later

---

## üéØ **Complete Configuration Summary**

### **1. Dockerfile Configuration** ‚úÖ

```dockerfile
# Key Settings:
USER doccano
WORKDIR /doccano/backend

# Explicitly set Django settings for production
ENV DJANGO_SETTINGS_MODULE=config.settings.production

# Production-ready CMD
CMD echo "üîç DATABASE_URL: ${DATABASE_URL:0:30}..." && \
    echo "üêç Django Settings: $DJANGO_SETTINGS_MODULE" && \
    python manage.py migrate --noinput && \
    gunicorn --bind=0.0.0.0:${PORT:-8000} \
             --workers=${WEB_CONCURRENCY:-1} \
             --timeout=300 \
             config.wsgi:application
```

**Key Points:**
- ‚úÖ Uses `config.settings.production` (correct)
- ‚úÖ Shell form CMD for env var expansion
- ‚úÖ Auto-runs migrations on startup
- ‚úÖ Starts gunicorn web server
- ‚úÖ Debug output for troubleshooting

---

### **2. Render Environment Variables** ‚úÖ

**Required (Auto-generated by Render):**
```bash
DATABASE_URL=postgres://user:pass@host.render.com:5432/dbname  # Auto-set
PORT=10000                                                      # Auto-set
```

**Optional (Recommended):**
```bash
ADMIN_USERNAME=admin
ADMIN_PASSWORD=your-secure-password-here
ADMIN_EMAIL=admin@monlam.ai
SECRET_KEY=your-random-secret-key
DEBUG=False
```

**DO NOT SET:**
```bash
‚ùå DJANGO_SETTINGS_MODULE  # Let Dockerfile handle this!
```

---

### **3. Custom Apps Integrated** ‚úÖ

#### **`assignment` App**
- Location: `/doccano/backend/assignment/`
- Purpose: Assignment system and annotation tracking
- Migrations: `0001_initial` ‚Üí `0003_example_locking` ‚Üí `0006_annotation_tracking_simple`
- Tables: `assignment_example`, `annotation_tracking`

#### **`monlam_tracking` App**
- Location: `/doccano/backend/monlam_tracking/`
- Purpose: Visibility filtering (DRF filter backend)
- Features: Auto-hides submitted examples from annotators
- Integration: Registered in `REST_FRAMEWORK['DEFAULT_FILTER_BACKENDS']`

#### **`monlam_ui` App**
- Location: `/doccano/backend/monlam_ui/`
- Purpose: Custom UI pages (completion dashboard)
- URLs: `/monlam/<project_id>/completion/`, `/monlam/<project_id>/dataset-enhanced/`
- Features: Enhanced metrics and dataset views

---

### **4. Frontend Enhancements** ‚úÖ

**File:** `patches/frontend/index.html` and `patches/frontend/200.html`

**Features Implemented:**
1. **Audio Auto-Loop** üîÅ
   - Auto-repeats audio on annotation pages
   - Detects page type via URL pattern
   
2. **Dataset Table Enhancement** üìä
   - Adds columns: "Annotated By" (position 4), "Reviewed By" (position 5), "Status" (position 6)
   - Fetches data from `EnhancedExampleSerializer`
   - Prevents duplicate enhancement with `data-monlam-enhanced` flag
   
3. **Metrics Page Redirect** üîÄ
   - 4-layer ultra-aggressive interception
   - Redirects `/projects/<id>/metrics` ‚Üí `/monlam/<id>/completion/`
   - Works on first click (no refresh needed)
   
4. **Approve/Reject Buttons** ‚úÖ‚ùå
   - Floating buttons at bottom-right of annotation page
   - Only visible to reviewers and project managers
   - Updates status via `/v1/projects/<id>/tracking/<example_id>/approve|reject/`

---

### **5. Database Schema** ‚úÖ

**Custom Tables:**

```sql
-- Annotation Tracking
CREATE TABLE annotation_tracking (
    id SERIAL PRIMARY KEY,
    project_id INTEGER NOT NULL REFERENCES projects_project(id),
    example_id INTEGER NOT NULL REFERENCES examples_example(id),
    annotated_by_id INTEGER REFERENCES auth_user(id),
    annotated_at TIMESTAMP,
    reviewed_by_id INTEGER REFERENCES auth_user(id),
    reviewed_at TIMESTAMP,
    status VARCHAR(20) DEFAULT 'pending',  -- pending, approved, rejected
    review_notes TEXT,
    locked_by_id INTEGER REFERENCES auth_user(id),
    locked_at TIMESTAMP,
    UNIQUE(project_id, example_id)
);

-- Assignment Examples
CREATE TABLE assignment_example (
    id SERIAL PRIMARY KEY,
    project_id INTEGER NOT NULL,
    example_id INTEGER NOT NULL,
    assignee_id INTEGER REFERENCES auth_user(id),
    assigned_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(project_id, example_id)
);
```

---

### **6. API Endpoints** ‚úÖ

**Assignment APIs:**
```
GET    /v1/projects/<id>/assignments/
POST   /v1/projects/<id>/assignments/
DELETE /v1/projects/<id>/assignments/<assignment_id>/
```

**Tracking APIs:**
```
POST   /v1/projects/<id>/tracking/<example_id>/approve/
POST   /v1/projects/<id>/tracking/<example_id>/reject/
GET    /v1/projects/<id>/tracking/<example_id>/status/
POST   /v1/projects/<id>/tracking/<example_id>/submit/
```

**Monlam UI Pages:**
```
GET    /monlam/<id>/completion/
GET    /monlam/<id>/dataset-enhanced/
GET    /monlam/<id>/api/completion-stats/
GET    /monlam/<id>/api/dataset-assignments/
```

---

### **7. Deployment Checklist** ‚úÖ

- [x] Dockerfile sets correct `DJANGO_SETTINGS_MODULE`
- [x] CMD uses shell form for env var expansion
- [x] Migrations run automatically on startup
- [x] Render environment variables configured correctly
- [x] `DJANGO_SETTINGS_MODULE` NOT set in Render (let Dockerfile handle it)
- [x] `DATABASE_URL` auto-generated by Render PostgreSQL
- [x] All custom apps copied and registered
- [x] Frontend patches applied
- [x] Gunicorn starts with proper settings

---

### **8. Expected Deployment Logs** ‚úÖ

```bash
==> Building...
[+] Building 45.2s (47/47) FINISHED
==> Pushing image to registry...
Upload succeeded

==> Deploying...
üîç DATABASE_URL: postgres://...
üêç Django Settings: config.settings.production

Running migrations:
  Operations to perform:
    Apply all migrations: admin, assignment, auth, ...
  Running migrations:
    Applying contenttypes.0001_initial... OK
    Applying auth.0001_initial... OK
    Applying assignment.0001_initial... OK
    Applying assignment.0002_alter_example_assignment... OK
    Applying assignment.0003_example_locking... OK
    Applying assignment.0006_annotation_tracking_simple... OK
    ... (more migrations) ...

[2026-01-07 12:34:56 +0000] [1] [INFO] Starting gunicorn 20.1.0
[2026-01-07 12:34:56 +0000] [1] [INFO] Listening at: http://0.0.0.0:10000 (1)
[2026-01-07 12:34:56 +0000] [8] [INFO] Booting worker with pid: 8

==> Live ‚úÖ
==> Your service is live üéâ
    https://annotate.monlam.ai
```

---

### **9. Post-Deployment Steps** ‚úÖ

#### **Create Admin User (if needed):**
```bash
# In Render Shell:
cd /doccano/backend
python manage.py create_admin \
  --username admin \
  --password MonlamAI2024 \
  --email admin@monlam.ai \
  --noinput
```

#### **Verify Database:**
```bash
# Check migrations:
python manage.py showmigrations

# Check tables:
python manage.py dbshell -c "\dt"

# Should show:
#   annotation_tracking
#   assignment_example
#   auth_user
#   ... (all other tables)
```

#### **Test Features:**
1. ‚úÖ Login at https://annotate.monlam.ai
2. ‚úÖ Create a test project (Speech-to-Text)
3. ‚úÖ Upload examples
4. ‚úÖ Check dataset table for custom columns (Annotated By, Reviewed By, Status)
5. ‚úÖ Click "Annotate" button on an example
6. ‚úÖ Verify audio auto-loops (if audio project)
7. ‚úÖ Check approve/reject buttons visible (if reviewer/PM)
8. ‚úÖ Click "Metrics" ‚Üí Should redirect to custom completion page

---

### **10. Troubleshooting** üîß

#### **If deployment fails with database error:**
```bash
# Check environment variables:
env | grep DATABASE_URL
env | grep DJANGO_SETTINGS_MODULE

# Should show:
DATABASE_URL=postgres://...
DJANGO_SETTINGS_MODULE=config.settings.production
```

#### **If migrations fail:**
```bash
# Reset database (see DATABASE_RESET_COMMANDS.md)
python manage.py dbshell << 'EOF'
DROP TABLE IF EXISTS annotation_tracking CASCADE;
DELETE FROM django_migrations WHERE app = 'assignment';
EOF

python manage.py migrate assignment --fake-initial
```

#### **If custom columns don't appear:**
1. Hard refresh browser (Ctrl+Shift+R / Cmd+Shift+R)
2. Clear browser cache
3. Check if `index.html` patch was applied (look at page source)

---

### **11. Performance Settings** ‚öôÔ∏è

**Gunicorn Configuration:**
```bash
--workers=${WEB_CONCURRENCY:-1}  # Render sets this automatically
--timeout=300                     # 5 minutes for long-running requests
--bind=0.0.0.0:${PORT}           # Bind to Render's assigned port
```

**Database Connection:**
```python
# Handled by dj-database-url in config.settings.production
# Automatically parses DATABASE_URL environment variable
```

---

### **12. Security** üîí

**Environment Variables:**
- ‚úÖ `SECRET_KEY` should be set to a random value
- ‚úÖ `DEBUG=False` in production
- ‚úÖ `DATABASE_URL` uses SSL (Render PostgreSQL)
- ‚úÖ Password hashing enabled by default (Django)

**CORS & CSRF:**
- Configured in `config.settings.production`
- Inherits from Doccano's secure defaults

---

### **13. Monitoring** üìä

**Health Checks:**
```bash
# Check if server is responding:
curl https://annotate.monlam.ai/v1/health
# Expected: 200 OK

# Check database connection:
curl https://annotate.monlam.ai/v1/projects/
# Expected: JSON list (or 401 if not authenticated)
```

**Logs:**
- View in Render Dashboard ‚Üí Logs tab
- Real-time streaming
- Look for Django SQL queries, errors, warnings

---

### **14. Backup & Restore** üíæ

**Database Backup:**
```bash
# In Render Shell:
pg_dump $DATABASE_URL > backup.sql

# Or use Render's automatic backups:
# Dashboard ‚Üí PostgreSQL ‚Üí Backups tab
```

**Restore:**
```bash
psql $DATABASE_URL < backup.sql
```

---

## üéâ **Success Criteria**

Your deployment is successful when:

- [x] Render shows "Live" status
- [x] https://annotate.monlam.ai loads
- [x] Can login with admin credentials
- [x] Dataset table shows custom columns (4, 5, 6)
- [x] Metrics page redirects to custom completion page
- [x] Audio auto-loops on annotation pages
- [x] Approve/reject buttons appear for reviewers
- [x] Examples filter correctly by user role

---

## üìö **Related Documentation**

- **FIX_RENDER_ENV.md** - How to fix environment variable issues
- **DATABASE_RESET_COMMANDS.md** - Complete database reset guide
- **CHECK_ENV_VARS.sh** - Diagnostic script for troubleshooting
- **IMPLEMENTATION_SUMMARY.md** - Detailed implementation notes

---

## üöÄ **Current Status**

**Commit:** `90f2739` and later  
**Render Environment:** ‚úÖ Configured correctly  
**Database:** Ready for migrations  
**Deployment:** Ready to go Live! üéâ

---

**Everything is ready for production deployment!** ‚úÖ

